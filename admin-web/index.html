<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>خبير - لوحة التحكم</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/superjson@2.2.1/dist/index.umd.js"></script>
  <!-- Always load tRPC helper from backend to avoid 404/MIME issues on live-server -->
  <script src="http://localhost:3000/admin/trpc-client.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f4f1;
      --surface: #ffffff;
      --surface-muted: #fbf8f5;
      --border: #e6dcd2;
      --muted: #6b6460;
      --foreground: #1f1917;
      --primary: #8B1538;
      --primary-2: #C9375D;
    }
    * { font-family: 'Tajawal', sans-serif; }
    body.bg-gray-50 { background: radial-gradient(circle at 20% 20%, #fbf5f1, #f2ebe7 45%, #eee5e0); color: var(--foreground); }
    h1, h2, h3, h4 { color: var(--foreground); }
    p, span, label { color: var(--muted); }

    /* Surfaces */
    .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border: 1px solid rgba(230, 220, 210, 0.7); box-shadow: 0 20px 40px rgba(0,0,0,0.06); }
    .shadow-lg, .shadow-xl { box-shadow: 0 18px 45px rgba(0,0,0,0.08) !important; border: 1px solid var(--border); }
    .bg-white { background-color: var(--surface) !important; }

    /* Sidebar */
    .sidebar-item { border: 1px solid transparent; border-radius: 14px; }
    .sidebar-item:hover { background: rgba(139, 21, 56, 0.04); }
    .sidebar-item.active { background: rgba(139, 21, 56, 0.08); color: var(--primary); border-right: 3px solid var(--primary); }

    /* Buttons */
    .gradient-bg { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); }
    .btn-soft { background: var(--surface-muted); border: 1px solid var(--border); color: var(--foreground); }
    .btn-soft:hover { border-color: var(--primary); color: var(--primary); }

    /* Inputs */
    input, select, textarea { background: var(--surface); border-color: var(--border) !important; color: var(--foreground); }
    input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(139, 21, 56, 0.12); }

    /* Cards / tables */
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border); background: var(--surface); }
    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 14px 30px rgba(0,0,0,0.08); }
    table thead th { background: var(--surface-muted); color: var(--foreground); }
    table tbody tr:nth-child(odd) { background: #fcf9f6; }
    table tbody tr:hover { background: rgba(139, 21, 56, 0.04); }

    /* Chips / tabs */
    .tab-btn { border: 1px solid var(--border); background: var(--surface); color: var(--muted); }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Dropzones */
    .file-drop-zone { border: 2px dashed var(--border); transition: all 0.3s; background: var(--surface-muted); }
    .file-drop-zone:hover, .file-drop-zone.dragover { border-color: var(--primary); background: rgba(139, 21, 56, 0.05); }

    /* Toggles */
    .toggle-switch { position: relative; width: 48px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: #d1d5db; border-radius: 24px; transition: 0.3s; }
    .toggle-slider:before { content: ''; position: absolute; height: 18px; width: 18px; right: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    input:checked + .toggle-slider { background: var(--primary); }
    input:checked + .toggle-slider:before { transform: translateX(-24px); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
    <div class="glass-card rounded-3xl p-10 w-full max-w-md shadow-2xl">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-[#8B1538] to-[#C9375D] rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
          <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">خبير</h1>
        <p class="text-gray-500 mt-2">لوحة تحكم المشرف</p>
      </div>
      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
          <input type="email" id="adminEmail" required
            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent transition"
            placeholder="admin@khabeer.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
          <input type="password" id="adminPassword" required
            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent transition"
            placeholder="••••••••">
        </div>
        <button type="submit"
          class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90 transition shadow-lg">
          تسجيل الدخول
        </button>
      </form>
      <p id="loginError" class="text-red-500 text-center mt-4 hidden">بيانات الدخول غير صحيحة</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Sidebar -->
    <aside class="fixed right-0 top-0 h-full w-72 bg-white shadow-xl z-50 flex flex-col">
      <div class="p-6 border-b">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
            </svg>
          </div>
          <div>
            <h1 class="font-bold text-xl text-gray-800">خبير</h1>
            <p class="text-xs text-gray-500">لوحة التحكم</p>
          </div>
        </div>
      </div>
      
      <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
        <button onclick="showSection('dashboard-section', event)" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
          <span>لوحة المعلومات</span>
        </button>
        <button onclick="showSection('analytics-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
          <span>التحليلات</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">المحتوى</p>
        </div>
        <button onclick="showSection('knowledge-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
          <span>قاعدة المعرفة</span>
        </button>
        <button onclick="showSection('news-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
          <span>الأخبار</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">المستخدمين</p>
        </div>
        <button onclick="showSection('users-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
          <span>المستخدمين</span>
        </button>
        <button onclick="showSection('consultants-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
          <span>المستشارين</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">الإعدادات</p>
        </div>
        <button onclick="showSection('ai-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
          <span>إعدادات الذكاء الاصطناعي</span>
        </button>
        <button onclick="showSection('notifications-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
          <span>الإشعارات</span>
        </button>
        <button onclick="showSection('api-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
          <span>مفاتيح API</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">المالية</p>
        </div>
        <button onclick="showSection('packages-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
          <span>الباقات والاشتراكات</span>
        </button>
        <button onclick="showSection('payment-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
          <span>بوابات الدفع</span>
        </button>
        <button onclick="showSection('vendors-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
          <span>سوق الخبراء</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">محرك النمو</p>
        </div>
        <button onclick="showSection('growth-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
          <span>إعدادات التسعير والتحويل</span>
        </button>
        
        <button onclick="showSection('tests-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
          <span>اختبارات الشركات</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">قانوني</p>
        </div>
        <button onclick="showSection('privacy-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
          <span>السياسة والخصوصية</span>
        </button>
      </nav>

      <div class="p-4 border-t">
        <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          <span>تسجيل الخروج</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="mr-72 p-8">
      <!-- Dashboard Section -->
      <section id="dashboard-section">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">مرحباً بك في لوحة التحكم</h2>
          <p class="text-gray-500 mt-1">نظرة عامة على أداء منصة خبير</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
              </div>
              <span class="text-green-500 text-sm font-medium">+12%</span>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-users">0</p>
            <p class="text-gray-500 text-sm mt-1">إجمالي المستخدمين</p>
          </div>

          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
              </div>
              <span class="text-green-500 text-sm font-medium">+28%</span>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-conversations">0</p>
            <p class="text-gray-500 text-sm mt-1">المحادثات</p>
          </div>

          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              </div>
              <span class="text-green-500 text-sm font-medium">+8%</span>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-contracts">0</p>
            <p class="text-gray-500 text-sm mt-1">العقود المحللة</p>
          </div>

          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
              </div>
              <span class="text-green-500 text-sm font-medium">+15%</span>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-stocks">0</p>
            <p class="text-gray-500 text-sm mt-1">الأسهم المفحوصة</p>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">النشاط الأخير</h3>
          <div class="space-y-4" id="recent-activity">
            <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
              </div>
              <div class="flex-1">
                <p class="text-gray-800 font-medium">مستخدم جديد سجل في المنصة</p>
                <p class="text-gray-500 text-sm">منذ 5 دقائق</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Analytics Section -->
      <section id="analytics-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">التحليلات</h2>
          <p class="text-gray-500 mt-1">إحصائيات مفصلة عن استخدام المنصة</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">الاستخدام اليومي</h3>
            <div class="chart-container">
              <canvas id="usageChart"></canvas>
            </div>
          </div>

          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">توزيع الاستفسارات</h3>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إحصائيات تفصيلية</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-xl">
              <p class="text-3xl font-bold text-[#8B1538]">89%</p>
              <p class="text-gray-500 text-sm mt-1">معدل الرضا</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-xl">
              <p class="text-3xl font-bold text-[#8B1538]">2.3s</p>
              <p class="text-gray-500 text-sm mt-1">متوسط وقت الاستجابة</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-xl">
              <p class="text-3xl font-bold text-[#8B1538]">4.2</p>
              <p class="text-gray-500 text-sm mt-1">أسئلة/جلسة</p>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-xl">
              <p class="text-3xl font-bold text-[#8B1538]">67%</p>
              <p class="text-gray-500 text-sm mt-1">معدل العودة</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Knowledge Base Section -->
      <section id="knowledge-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">قاعدة المعرفة</h2>
          <p class="text-gray-500 mt-1">إدارة المصادر والمستندات للذكاء الاصطناعي</p>
        </div>

        <!-- Upload Zone -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">رفع مستند جديد</h3>
          <div id="fileDropZone" class="file-drop-zone rounded-2xl p-8 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt,.doc,.docx" onchange="handleFileSelect(event)">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p class="text-gray-600 font-medium mb-2">اسحب الملفات هنا أو انقر للاختيار</p>
            <p class="text-gray-400 text-sm">PDF, TXT, DOC, DOCX - الحد الأقصى 50MB</p>
          </div>
          
          <!-- Upload Progress -->
          <div id="uploadProgress" class="hidden mt-4">
            <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
              <div class="w-10 h-10 bg-[#8B1538] bg-opacity-10 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-[#8B1538] animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <p class="text-gray-800 font-medium" id="uploadFileName">جاري الرفع...</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                  <div id="uploadProgressBar" class="bg-[#8B1538] h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- AI Processing Status -->
          <div id="aiProcessing" class="hidden mt-4">
            <div class="flex items-center gap-4 p-4 bg-purple-50 rounded-xl">
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-purple-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <p class="text-purple-800 font-medium">جاري معالجة المستند بالذكاء الاصطناعي</p>
                <p class="text-purple-600 text-sm">استخراج المحتوى وتحليله وفهرسته...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents List -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">المستندات المرفوعة</h3>
            <select id="docTypeFilter" class="px-4 py-2 rounded-lg border border-gray-200 text-sm" onchange="filterDocuments()">
              <option value="all">جميع الأنواع</option>
              <option value="fatwa">فتاوى</option>
              <option value="standard">معايير</option>
              <option value="article">مقالات</option>
              <option value="scraped">محتوى مستورد</option>
            </select>
          </div>
          <div id="documentsList" class="space-y-3">
            <!-- Documents will be loaded here -->
          </div>
        </div>
      </section>

      <!-- News Section -->
      <section id="news-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">إدارة الأخبار</h2>
          <p class="text-gray-500 mt-1">رفع ونشر الأخبار المالية الإسلامية</p>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6">
          <button onclick="showNewsTab('manual')" class="tab-btn active px-6 py-2 rounded-xl font-medium transition">رفع يدوي</button>
          <button onclick="showNewsTab('automation')" class="tab-btn px-6 py-2 rounded-xl font-medium bg-gray-100 text-gray-600 transition">أتمتة الأخبار</button>
          <button onclick="showNewsTab('published')" class="tab-btn px-6 py-2 rounded-xl font-medium bg-gray-100 text-gray-600 transition">الأخبار المنشورة</button>
        </div>

        <!-- Manual Upload Tab -->
        <div id="news-manual" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إضافة خبر جديد</h3>
          <form id="newsForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">عنوان الخبر</label>
              <input type="text" id="newsTitle" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent" placeholder="أدخل عنوان الخبر">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">محتوى الخبر</label>
              <textarea id="newsContent" rows="5" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent resize-none" placeholder="أدخل محتوى الخبر"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">التصنيف</label>
                <select id="newsCategory" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538]">
                  <option value="markets">الأسواق</option>
                  <option value="banking">البنوك الإسلامية</option>
                  <option value="sukuk">الصكوك</option>
                  <option value="fatwa">الفتاوى</option>
                  <option value="regulations">التنظيمات</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">المصدر</label>
                <input type="text" id="newsSource" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538]" placeholder="اسم المصدر">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">صورة الخبر</label>
              <div class="file-drop-zone rounded-xl p-6 text-center cursor-pointer" onclick="document.getElementById('newsImageInput').click()">
                <input type="file" id="newsImageInput" class="hidden" accept="image/*" onchange="handleNewsImageSelect(event)">
                <div id="newsImagePreview" class="hidden mb-4">
                  <img id="newsImagePreviewImg" class="max-h-40 mx-auto rounded-lg">
                </div>
                <svg id="newsImageIcon" class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p class="text-gray-500 text-sm">انقر لاختيار صورة</p>
              </div>
            </div>
            <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              نشر الخبر
            </button>
          </form>
        </div>

        <!-- Automation Tab -->
        <div id="news-automation" class="hidden bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إعدادات أتمتة الأخبار بالذكاء الاصطناعي</h3>
          
          <!-- Manual Sync Button -->
          <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-gray-800">مزامنة الأخبار الآن</p>
                <p class="text-sm text-gray-600">جلب الأخبار من NewsAPI و AAOIFI</p>
              </div>
              <button onclick="syncNewsNow()" id="syncNewsBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                <span id="syncNewsBtnText">مزامنة الآن</span>
              </button>
            </div>
            <div id="syncNewsStatus" class="mt-3 text-sm hidden"></div>
          </div>
          
          <div class="space-y-6">
            <!-- Enable Automation -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div>
                <p class="font-medium text-gray-800">تفعيل الأتمتة</p>
                <p class="text-sm text-gray-500">السماح للذكاء الاصطناعي باختيار ونشر الأخبار تلقائياً</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="newsAutomationEnabled">
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- News Sources -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">مصادر الأخبار (RSS Feeds)</label>
              <div id="newsSourcesList" class="space-y-2 mb-3">
                <div class="flex items-center gap-2">
                  <input type="text" class="flex-1 px-4 py-2 rounded-lg border border-gray-200" value="https://www.aaoifi.com/feed/" readonly>
                  <button class="text-red-500 hover:bg-red-50 p-2 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
              </div>
              <div class="flex gap-2">
                <input type="text" id="newRssSource" class="flex-1 px-4 py-2 rounded-lg border border-gray-200" placeholder="أضف رابط RSS جديد">
                <button onclick="addNewsSource()" class="gradient-bg text-white px-4 py-2 rounded-lg">إضافة</button>
              </div>
            </div>

            <!-- AI Settings -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">عدد الأخبار يومياً</label>
                <select id="newsPerDay" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="3">3 أخبار</option>
                  <option value="5" selected>5 أخبار</option>
                  <option value="10">10 أخبار</option>
                  <option value="15">15 خبر</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">وقت النشر</label>
                <select id="newsPublishTime" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="morning">صباحاً (8:00)</option>
                  <option value="afternoon">ظهراً (12:00)</option>
                  <option value="evening">مساءً (18:00)</option>
                  <option value="distributed">موزع على اليوم</option>
                </select>
              </div>
            </div>

            <!-- News Types -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">أنواع الأخبار المفضلة</label>
              <div class="flex flex-wrap gap-2">
                <label class="flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-lg cursor-pointer">
                  <input type="checkbox" checked class="rounded text-[#8B1538]">
                  <span>أسواق المال</span>
                </label>
                <label class="flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-lg cursor-pointer">
                  <input type="checkbox" checked class="rounded text-[#8B1538]">
                  <span>البنوك الإسلامية</span>
                </label>
                <label class="flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-lg cursor-pointer">
                  <input type="checkbox" checked class="rounded text-[#8B1538]">
                  <span>الصكوك</span>
                </label>
                <label class="flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-lg cursor-pointer">
                  <input type="checkbox" class="rounded text-[#8B1538]">
                  <span>التنظيمات</span>
                </label>
                <label class="flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-lg cursor-pointer">
                  <input type="checkbox" class="rounded text-[#8B1538]">
                  <span>الفتاوى</span>
                </label>
              </div>
            </div>

            <!-- AI Writing Style -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">أسلوب صياغة الخبر</label>
              <textarea id="newsWritingStyle" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none" placeholder="وصف أسلوب الكتابة المطلوب...">اكتب الأخبار بأسلوب صحفي احترافي، مع التركيز على الجانب الشرعي والمالي. استخدم لغة عربية فصحى سهلة الفهم. أضف سياقاً توضيحياً للمصطلحات المالية الإسلامية.</textarea>
            </div>

            <button onclick="saveNewsAutomation()" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              حفظ الإعدادات
            </button>
          </div>
        </div>

        <!-- Published News Tab -->
        <div id="news-published" class="hidden bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">الأخبار المنشورة</h3>
          <div id="publishedNewsList" class="space-y-4">
            <!-- News items will be loaded here -->
          </div>
        </div>
      </section>

      <!-- Users Section -->
      <section id="users-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">إدارة المستخدمين</h2>
          <p class="text-gray-500 mt-1">إدارة حسابات المستخدمين والصلاحيات والباقات</p>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center">
            <p class="text-2xl font-bold text-gray-800" id="totalUsers">0</p>
            <p class="text-gray-500 text-sm">إجمالي المستخدمين</p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center">
            <p class="text-2xl font-bold text-green-600" id="activeUsers">0</p>
            <p class="text-gray-500 text-sm">نشط</p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center">
            <p class="text-2xl font-bold text-amber-600" id="proUsers">0</p>
            <p class="text-gray-500 text-sm">باقة Pro</p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 text-center">
            <p class="text-2xl font-bold text-purple-600" id="enterpriseUsers">0</p>
            <p class="text-gray-500 text-sm">باقة Enterprise</p>
          </div>
        </div>

        <!-- Add User Form -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إضافة مستخدم جديد</h3>
          <form id="addUserForm" class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الكامل</label>
              <input type="text" id="newUserName" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
              <input type="email" id="newUserEmail" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
              <input type="tel" id="newUserPhone" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
              <input type="password" id="newUserPassword" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">نوع المستخدم</label>
              <select id="newUserRole" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="user">مستخدم عادي</option>
                <option value="consultant">مستشار</option>
                <option value="admin">مشرف</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الباقة</label>
              <select id="newUserPackage" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="free">مجانية (5 أسئلة/يوم)</option>
                <option value="pro">Pro (غير محدود)</option>
                <option value="enterprise">Enterprise</option>
              </select>
            </div>
            <div class="col-span-2 flex items-center gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="newUserFreePackage" class="w-4 h-4 text-[#8B1538] rounded">
                <span class="text-sm text-gray-700">منح الباقة مجاناً (بدون دفع)</span>
              </label>
            </div>
            <div class="col-span-2">
              <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
                إضافة المستخدم
              </button>
            </div>
          </form>
        </div>

        <!-- Daily Limit Settings -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إعدادات المحاولات اليومية</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة للباقة المجانية (يومياً)</label>
              <input type="number" id="freeDailyLimit" value="5" min="1" max="100" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة للضيف (يومياً)</label>
              <input type="number" id="guestDailyLimit" value="3" min="1" max="50" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div class="col-span-2">
              <button onclick="saveDailyLimits()" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
                حفظ الإعدادات
              </button>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="p-4 border-b flex items-center justify-between">
            <input type="text" id="userSearch" class="px-4 py-2 rounded-lg border border-gray-200 w-64" placeholder="بحث عن مستخدم..." oninput="searchUsers()">
            <div class="flex gap-2">
              <select id="userRoleFilter" class="px-4 py-2 rounded-lg border border-gray-200" onchange="filterUsers()">
                <option value="all">جميع الأدوار</option>
                <option value="user">مستخدم</option>
                <option value="consultant">مستشار</option>
                <option value="admin">مشرف</option>
              </select>
              <select id="userStatusFilter" class="px-4 py-2 rounded-lg border border-gray-200" onchange="filterUsers()">
                <option value="all">جميع الحالات</option>
                <option value="active">نشط</option>
                <option value="suspended">معلق</option>
                <option value="disabled">معطل</option>
              </select>
            </div>
          </div>
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">المستخدم</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الدور</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الباقة</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الحالة</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الإجراءات</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-100">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>

        <!-- User Edit Modal -->
        <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-gray-800 mb-4">تعديل المستخدم</h3>
            <form id="userEditForm" class="space-y-4">
              <input type="hidden" id="editUserId">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">الدور</label>
                <select id="editUserRole" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="user">مستخدم</option>
                  <option value="consultant">مستشار</option>
                  <option value="admin">مشرف</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">الباقة</label>
                <select id="editUserPackage" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="free">مجانية</option>
                  <option value="pro">Pro</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">الحالة</label>
                <select id="editUserStatus" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="active">نشط</option>
                  <option value="suspended">معلق</option>
                  <option value="disabled">معطل</option>
                </select>
              </div>
              <div class="flex gap-3">
                <button type="submit" class="flex-1 gradient-bg text-white py-3 rounded-xl font-semibold">حفظ</button>
                <button type="button" onclick="closeUserModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold">إلغاء</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Consultants Section -->
      <section id="consultants-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">إدارة المستشارين</h2>
          <p class="text-gray-500 mt-1">إضافة وإدارة المستشارين الشرعيين</p>
        </div>

        <!-- Add Consultant -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إضافة مستشار جديد</h3>
          <form id="consultantForm" class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الكامل</label>
              <input type="text" id="consultantName" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
              <input type="email" id="consultantEmail" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">التخصص</label>
              <select id="consultantSpecialty" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="stocks">الأسهم والاستثمارات</option>
                <option value="contracts">العقود والمعاملات</option>
                <option value="banking">البنوك الإسلامية</option>
                <option value="sukuk">الصكوك</option>
                <option value="general">عام</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الحد الأقصى للمحادثات يومياً</label>
              <input type="number" id="consultantMaxChats" value="10" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">نبذة تعريفية</label>
              <textarea id="consultantBio" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none"></textarea>
            </div>
            <div class="col-span-2">
              <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
                إضافة المستشار
              </button>
            </div>
          </form>
        </div>

        <!-- Consultants List -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">المستشارين الحاليين</h3>
          <div id="consultantsList" class="space-y-4">
            <!-- Consultants will be loaded here -->
          </div>
        </div>
      </section>

      <!-- AI Settings Section -->
      <section id="ai-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">إعدادات الذكاء الاصطناعي</h2>
          <p class="text-gray-500 mt-1">تخصيص سلوك المستشار الذكي</p>
        </div>

        <!-- AI Tabs -->
        <div class="flex gap-2 mb-6">
          <button onclick="showAITab('conversation')" class="tab-btn active px-6 py-2 rounded-xl font-medium transition">نظام المحادثة</button>
          <button onclick="showAITab('sources')" class="tab-btn px-6 py-2 rounded-xl font-medium bg-gray-100 text-gray-600 transition">استيراد المصادر</button>
          <button onclick="showAITab('personality')" class="tab-btn px-6 py-2 rounded-xl font-medium bg-gray-100 text-gray-600 transition">شخصية الذكاء</button>
        </div>

        <!-- Conversation System Tab -->
        <div id="ai-conversation" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">نظام المحادثة (System Prompt)</h3>
          <textarea id="systemPrompt" rows="12" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent resize-none mb-4">أنت مستشار مالي إسلامي متخصص في الشريعة الإسلامية والتمويل الإسلامي. 
اسمك "خبير" وأنت تساعد المستخدمين في:
1. تحليل العقود والاتفاقيات من منظور شرعي
2. فحص توافق الأسهم والاستثمارات مع الشريعة الإسلامية
3. الإجابة على الاستفسارات المتعلقة بالمعاملات المالية الإسلامية
4. تقديم النصائح المالية المتوافقة مع الشريعة

قواعد مهمة:
- قدم إجابات مفصلة ومدعومة بالأدلة الشرعية
- اذكر المصادر والمراجع عند الإمكان
- كن حذراً في الفتاوى واذكر أن الأمر يحتاج لمراجعة عالم متخصص في الحالات المعقدة
- استخدم اللغة العربية الفصحى السهلة
- قدم الإجابات بشكل منظم ومرتب</textarea>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الحد الأقصى للرموز</label>
              <input type="number" id="maxTokens" value="2000" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">درجة الحرارة (Creativity)</label>
              <input type="range" id="temperature" min="0" max="100" value="70" class="w-full">
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>دقيق</span>
                <span>متوازن</span>
                <span>إبداعي</span>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl mb-4">
            <div>
              <p class="font-medium text-gray-800">تفعيل الذاكرة</p>
              <p class="text-sm text-gray-500">حفظ سياق المحادثة السابقة</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="enableMemory" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <button onclick="saveConversationSettings()" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
            حفظ التغييرات
          </button>
        </div>

        <!-- Sources Import Tab -->
        <div id="ai-sources" class="hidden bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">نظام استيراد وفهم المصادر</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">توجيهات معالجة المستندات</label>
              <textarea id="sourceProcessingPrompt" rows="6" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none">عند معالجة المستندات:
1. استخرج المفاهيم الشرعية الرئيسية
2. حدد الأحكام والفتاوى المذكورة
3. صنف المحتوى حسب الموضوع (أسهم، عقود، بنوك، صكوك)
4. احفظ المراجع والمصادر المذكورة
5. أنشئ ملخصاً للمحتوى الرئيسي</textarea>
            </div>

            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div>
                <p class="font-medium text-gray-800">تفعيل RAG</p>
                <p class="text-sm text-gray-500">استخدام قاعدة المعرفة في الإجابات</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="enableRAG" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">عدد المصادر في كل إجابة</label>
                <select id="sourcesPerAnswer" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="3">3 مصادر</option>
                  <option value="5" selected>5 مصادر</option>
                  <option value="7">7 مصادر</option>
                  <option value="10">10 مصادر</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">حد التشابه (Similarity Threshold)</label>
                <input type="range" id="similarityThreshold" min="0" max="100" value="70" class="w-full">
              </div>
            </div>

            <button onclick="saveSourceSettings()" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              حفظ التغييرات
            </button>
          </div>
        </div>

        <!-- Personality Tab -->
        <div id="ai-personality" class="hidden bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">شخصية الذكاء الاصطناعي</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">اسم المساعد</label>
              <input type="text" id="aiName" value="خبير" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">أسلوب التحدث</label>
              <select id="aiTone" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="formal">رسمي وأكاديمي</option>
                <option value="friendly" selected>ودود ومهني</option>
                <option value="simple">بسيط وسهل</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">وصف الشخصية</label>
              <textarea id="aiPersonality" rows="5" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none">أنا خبير، مستشارك الشرعي للتمويل الإسلامي. أتحدث بأسلوب ودود ومهني، وأحرص على تقديم معلومات دقيقة ومفيدة. أؤمن بأهمية التوازن بين الالتزام الشرعي والنجاح المالي.</textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">رسالة الترحيب</label>
              <textarea id="welcomeMessage" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none">مرحباً بك في خبير! أنا مستشارك الشرعي للتمويل الإسلامي. كيف يمكنني مساعدتك اليوم؟</textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div>
                  <p class="font-medium text-gray-800">إضافة الإيموجي</p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="useEmoji">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div>
                  <p class="font-medium text-gray-800">ذكر المصادر دائماً</p>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="alwaysCiteSources" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <button onclick="savePersonalitySettings()" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              حفظ التغييرات
            </button>
          </div>
        </div>
      </section>

      <!-- Notifications Section -->
      <section id="notifications-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">نظام الإشعارات</h2>
          <p class="text-gray-500 mt-1">إدارة الإشعارات التلقائية والبريد الإلكتروني</p>
        </div>

        <!-- Automation Triggers -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">الإشعارات التلقائية</h3>
          
          <div class="space-y-4">
            <!-- Registration -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                </div>
                <div>
                  <p class="font-medium text-gray-800">عند التسجيل</p>
                  <p class="text-sm text-gray-500">إرسال بريد ترحيبي للمستخدم الجديد</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <button onclick="editNotificationTemplate('registration')" class="text-[#8B1538] hover:bg-[#8B1538] hover:bg-opacity-10 px-3 py-1 rounded-lg text-sm">تعديل القالب</button>
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Purchase -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                  <p class="font-medium text-gray-800">عند شراء باقة</p>
                  <p class="text-sm text-gray-500">تأكيد الاشتراك وتفاصيل الباقة</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <button onclick="editNotificationTemplate('purchase')" class="text-[#8B1538] hover:bg-[#8B1538] hover:bg-opacity-10 px-3 py-1 rounded-lg text-sm">تعديل القالب</button>
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Cart Abandonment -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
                <div>
                  <p class="font-medium text-gray-800">سلة متروكة</p>
                  <p class="text-sm text-gray-500">تذكير بإتمام عملية الشراء</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <select class="px-3 py-1 rounded-lg border border-gray-200 text-sm">
                  <option>بعد ساعة</option>
                  <option>بعد 24 ساعة</option>
                  <option>بعد 3 أيام</option>
                </select>
                <button onclick="editNotificationTemplate('cart')" class="text-[#8B1538] hover:bg-[#8B1538] hover:bg-opacity-10 px-3 py-1 rounded-lg text-sm">تعديل القالب</button>
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Unread Messages -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                </div>
                <div>
                  <p class="font-medium text-gray-800">رسائل غير مقروءة</p>
                  <p class="text-sm text-gray-500">إشعار التطبيق للمحادثات الجديدة</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- New Files -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <div>
                  <p class="font-medium text-gray-800">ملفات جديدة</p>
                  <p class="text-sm text-gray-500">إشعار عند إضافة ملف من المستشار</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Custom Trigger -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إضافة إشعار مخصص</h3>
          <form id="customTriggerForm" class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">اسم الإشعار</label>
              <input type="text" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="مثال: تذكير بالتجديد">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الحدث المُفعِّل</label>
              <select class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option>قبل انتهاء الاشتراك</option>
                <option>بعد عدد محادثات معين</option>
                <option>عدم النشاط لفترة</option>
                <option>مخصص</option>
              </select>
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">نص الإشعار</label>
              <textarea rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none" placeholder="محتوى الإشعار..."></textarea>
            </div>
            <div class="col-span-2">
              <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
                إضافة الإشعار
              </button>
            </div>
          </form>
        </div>

        <!-- Broadcast -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إرسال إشعار جماعي</h3>
          <form id="broadcastForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">العنوان</label>
              <input type="text" id="broadcastTitle" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="عنوان الإشعار">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">المحتوى</label>
              <textarea id="broadcastBody" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none" placeholder="محتوى الإشعار"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الفئة المستهدفة</label>
              <select id="broadcastTarget" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="all">جميع المستخدمين</option>
                <option value="free">الباقة المجانية</option>
                <option value="pro">باقة Pro</option>
                <option value="enterprise">باقة Enterprise</option>
              </select>
            </div>
            <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              إرسال الإشعار
            </button>
          </form>
        </div>
      </section>

      <!-- API Keys Section -->
      <section id="api-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">مفاتيح API</h2>
          <p class="text-gray-500 mt-1">إدارة مفاتيح الوصول للمطورين</p>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إنشاء مفتاح جديد</h3>
          <form id="apiKeyForm" class="flex gap-4">
            <input type="text" id="apiKeyName" class="flex-1 px-4 py-3 rounded-xl border border-gray-200" placeholder="اسم المفتاح (مثال: تطبيق iOS)">
            <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              إنشاء
            </button>
          </form>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">المفاتيح الحالية</h3>
          <div id="apiKeysList" class="space-y-3">
            <!-- API keys will be loaded here -->
          </div>
        </div>
      </section>

      <!-- Packages Section -->
      <section id="packages-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">الباقات والاشتراكات</h2>
          <p class="text-gray-500 mt-1">إدارة خطط الاشتراك ومميزاتها</p>
        </div>

        <!-- Add Package -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إنشاء باقة جديدة</h3>
          <form id="packageForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">اسم الباقة</label>
                <input type="text" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="مثال: باقة Pro">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">السعر (ريال/شهر)</label>
                <input type="number" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="99">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة/النقاط</label>
                <input type="number" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="100">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">مدة الاشتراك</label>
                <select class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option>شهري</option>
                  <option>ربع سنوي</option>
                  <option>سنوي</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">المميزات</label>
              <div class="grid grid-cols-2 gap-3">
                <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#8B1538]" checked>
                  <span class="text-sm">محادثات AI</span>
                </label>
                <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#8B1538]" checked>
                  <span class="text-sm">فحص الأسهم</span>
                </label>
                <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#8B1538]">
                  <span class="text-sm">تحليل العقود</span>
                </label>
                <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#8B1538]">
                  <span class="text-sm">استشارة مستشار</span>
                </label>
                <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#8B1538]">
                  <span class="text-sm">تقارير مفصلة</span>
                </label>
                <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#8B1538]">
                  <span class="text-sm">أولوية الدعم</span>
                </label>
              </div>
            </div>
            <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              إنشاء الباقة
            </button>
          </form>
        </div>

        <!-- Existing Packages -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">الباقات الحالية</h3>
          <div class="grid grid-cols-3 gap-6">
            <!-- Free Package -->
            <div class="border border-gray-200 rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-bold text-lg">مجاني</h4>
                <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">افتراضي</span>
              </div>
              <p class="text-3xl font-bold text-gray-800 mb-4">0 <span class="text-sm font-normal text-gray-500">ريال/شهر</span></p>
              <ul class="space-y-2 text-sm text-gray-600 mb-4">
                <li class="flex items-center gap-2">✅ 10 أسئلة/شهر</li>
                <li class="flex items-center gap-2">✅ فحص 5 أسهم</li>
                <li class="flex items-center gap-2">❌ تحليل العقود</li>
                <li class="flex items-center gap-2">❌ استشارة مستشار</li>
              </ul>
              <button onclick="editDefaultPackage('free')" class="w-full py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50">تعديل</button>
            </div>
            <!-- Pro Package -->
            <div class="border-2 border-[#8B1538] rounded-2xl p-6 relative">
              <div class="absolute -top-3 right-4 bg-[#8B1538] text-white px-3 py-1 rounded-full text-xs">الأكثر شعبية</div>
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-bold text-lg">Pro</h4>
                <span class="bg-[#8B1538] bg-opacity-10 text-[#8B1538] px-3 py-1 rounded-full text-sm">مفعل</span>
              </div>
              <p class="text-3xl font-bold text-[#8B1538] mb-4">99 <span class="text-sm font-normal text-gray-500">ريال/شهر</span></p>
              <ul class="space-y-2 text-sm text-gray-600 mb-4">
                <li class="flex items-center gap-2">✅ 100 سؤال/شهر</li>
                <li class="flex items-center gap-2">✅ فحص غير محدود للأسهم</li>
                <li class="flex items-center gap-2">✅ تحليل 10 عقود</li>
                <li class="flex items-center gap-2">❌ استشارة مستشار</li>
              </ul>
              <button onclick="editDefaultPackage('pro')" class="w-full py-2 gradient-bg text-white rounded-xl hover:opacity-90">تعديل</button>
            </div>
            <!-- Enterprise Package -->
            <div class="border border-gray-200 rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-bold text-lg">Enterprise</h4>
                <span class="bg-amber-100 text-amber-600 px-3 py-1 rounded-full text-sm">مفعل</span>
              </div>
              <p class="text-3xl font-bold text-gray-800 mb-4">299 <span class="text-sm font-normal text-gray-500">ريال/شهر</span></p>
              <ul class="space-y-2 text-sm text-gray-600 mb-4">
                <li class="flex items-center gap-2">✅ أسئلة غير محدودة</li>
                <li class="flex items-center gap-2">✅ فحص غير محدود للأسهم</li>
                <li class="flex items-center gap-2">✅ تحليل غير محدود للعقود</li>
                <li class="flex items-center gap-2">✅ استشارة مستشار مباشرة</li>
              </ul>
              <button onclick="editDefaultPackage('enterprise')" class="w-full py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50">تعديل</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Payment Gateways Section -->
      <section id="payment-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">بوابات الدفع</h2>
          <p class="text-gray-500 mt-1">ربط وإدارة بوابات الدفع الإلكتروني</p>
        </div>

        <div class="grid grid-cols-2 gap-6">
          <!-- MyFatoorah -->
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                  <span class="text-2xl font-bold text-blue-600">MF</span>
                </div>
                <div>
                  <h3 class="font-bold text-lg">ماي فاتورة</h3>
                  <p class="text-sm text-gray-500">بوابة دفع خليجية</p>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="myfatoorahEnabled">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">API Token</label>
                <input type="password" id="myfatoorahToken" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="أدخل المفتاح">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">البيئة</label>
                <select id="myfatoorahEnvironment" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="sandbox">تجريبي (Sandbox)</option>
                  <option value="production">إنتاجي (Production)</option>
                </select>
              </div>
              <button onclick="saveMyfatoorah()" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90">حفظ الإعدادات</button>
            </div>
          </div>

          <!-- Stripe -->
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
                  <span class="text-2xl font-bold text-purple-600">S</span>
                </div>
                <div>
                  <h3 class="font-bold text-lg">Stripe</h3>
                  <p class="text-sm text-gray-500">بوابة دفع عالمية</p>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="stripeEnabled">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Publishable Key</label>
                <input type="text" id="stripePublicKey" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="pk_...">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Secret Key</label>
                <input type="password" id="stripeSecretKey" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="sk_...">
              </div>
              <button onclick="saveStripe()" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90">حفظ الإعدادات</button>
            </div>
          </div>

          <!-- Tap -->
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                  <span class="text-2xl font-bold text-green-600">T</span>
                </div>
                <div>
                  <h3 class="font-bold text-lg">Tap Payments</h3>
                  <p class="text-sm text-gray-500">بوابة دفع خليجية</p>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="tapEnabled">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Secret Key</label>
                <input type="password" id="tapSecretKey" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="sk_...">
              </div>
              <button onclick="saveTap()" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90">حفظ الإعدادات</button>
            </div>
          </div>

          <!-- Apple Pay / Google Pay -->
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-6">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center">
                  <span class="text-2xl">📱</span>
                </div>
                <div>
                  <h3 class="font-bold text-lg">الدفع عبر التطبيق</h3>
                  <p class="text-sm text-gray-500">App Store / Google Play</p>
                </div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="inAppEnabled" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <p class="text-sm text-gray-500">يتم الدفع عبر متاجر التطبيقات مباشرة. لا يحتاج إعداد إضافي.</p>
          </div>
        </div>
      </section>

      <!-- Company Tests Section -->
      <section id="tests-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">اختبارات الشركات</h2>
          <p class="text-gray-500 mt-1">إدارة أسئلة وإجابات اختبار التوافق الشرعي للشركات</p>
        </div>

        <!-- Add New Question -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إضافة سؤال جديد</h3>
          <form id="addTestQuestionForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">نص السؤال</label>
              <input type="text" id="newQuestionText" required
                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent"
                placeholder="أدخل نص السؤال...">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الفئة</label>
              <select id="newQuestionCategory" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent">
                <option value="financial">المعاملات المالية</option>
                <option value="contracts">العقود والاتفاقيات</option>
                <option value="investments">الاستثمارات</option>
                <option value="operations">العمليات التشغيلية</option>
                <option value="governance">الحوكمة الشرعية</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الوزن (1-10)</label>
              <input type="number" id="newQuestionWeight" min="1" max="10" value="5"
                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#8B1538] focus:border-transparent">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">إجابة "نعم" تعني</label>
                <select id="newQuestionYesResult" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="compliant">متوافق</option>
                  <option value="non_compliant">غير متوافق</option>
                  <option value="needs_review">يحتاج مراجعة</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">إجابة "لا" تعني</label>
                <select id="newQuestionNoResult" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                  <option value="compliant">متوافق</option>
                  <option value="non_compliant">غير متوافق</option>
                  <option value="needs_review">يحتاج مراجعة</option>
                </select>
              </div>
            </div>
            <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
              إضافة السؤال
            </button>
          </form>
        </div>

        <!-- Questions List -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-bold text-gray-800">قائمة الأسئلة</h3>
            <div class="flex gap-2">
              <select id="filterCategory" onchange="filterTestQuestions()" class="px-4 py-2 rounded-xl border border-gray-200 text-sm">
                <option value="all">جميع الفئات</option>
                <option value="financial">المعاملات المالية</option>
                <option value="contracts">العقود والاتفاقيات</option>
                <option value="investments">الاستثمارات</option>
                <option value="operations">العمليات التشغيلية</option>
                <option value="governance">الحوكمة الشرعية</option>
              </select>
            </div>
          </div>
          <div id="testQuestionsList" class="space-y-4">
            <!-- Questions will be loaded here -->
          </div>
        </div>
      </section>

      <!-- Privacy Policy Section -->
      <section id="privacy-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">السياسة والخصوصية</h2>
          <p class="text-gray-500 mt-1">إدارة السياسات والشروط القانونية</p>
        </div>

        <!-- Privacy Policy -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">سياسة الخصوصية</h3>
          <textarea id="privacyPolicy" rows="12" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none font-mono text-sm" dir="rtl">سياسة الخصوصية لمنصة خبير

آخر تحديث: 1 يناير 2025

1. المقدمة
نحن في منصة خبير نلتزم بحماية خصوصيتك وبياناتك الشخصية.

2. البيانات التي نجمعها
- معلومات الحساب (الاسم، البريد الإلكتروني، رقم الهاتف)
- سجل المحادثات مع المستشار الذكي
- الملفات المرفوعة للتحليل

3. كيف نستخدم بياناتك
- تقديم الاستشارات الشرعية
- تحسين خدماتنا
- إرسال الإشعارات المهمة

4. حماية البيانات
نستخدم تقنيات تشفير متقدمة لحماية بياناتك.

5. حقوقك
- طلب نسخة من بياناتك
- حذف حسابك
- تعديل معلوماتك</textarea>
          <button onclick="savePrivacyPolicy()" class="mt-4 gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">حفظ التعديلات</button>
        </div>

        <!-- Terms of Service -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">الشروط والأحكام</h3>
          <textarea id="termsOfService" rows="12" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none font-mono text-sm" dir="rtl">الشروط والأحكام لمنصة خبير

آخر تحديث: 1 يناير 2025

1. القبول
باستخدامك لمنصة خبير، فإنك توافق على هذه الشروط.

2. الخدمات
نقدم استشارات شرعية مالية عبر الذكاء الاصطناعي.

3. إخلاء المسؤولية
الاستشارات المقدمة للاسترشاد فقط ولا تعتبر فتوى رسمية.

4. الاشتراكات
- الباقات المدفوعة تجدد تلقائياً
- يمكن الإلغاء في أي وقت

5. الملكية الفكرية
جميع الحقوق محفوظة لمنصة خبير.</textarea>
          <button onclick="saveTermsOfService()" class="mt-4 gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">حفظ التعديلات</button>
        </div>
      </section>

      <!-- Growth Engine Settings Section -->
      <section id="growth-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">إعدادات التسعير والتحويل</h2>
          <p class="text-gray-500 mt-1">تحكم في محرك النمو ومعايير التحويل للخبراء</p>
        </div>

        <!-- Pricing Variables -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">متغيرات التسعير</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">سعر اشتراك Pro (د.ك)</label>
              <input type="number" id="proPrice" value="8" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">نسبة عمولة المنصة (%)</label>
              <input type="number" id="platformCommission" value="30" min="0" max="100" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الحد الأدنى لسعر الخبير (د.ك)</label>
              <input type="number" id="minExpertPrice" value="40" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الحد الأقصى لسعر الخبير (د.ك)</label>
              <input type="number" id="maxExpertPrice" value="100" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
          </div>
          <button onclick="savePricingSettings()" class="mt-4 gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">حفظ التسعير</button>
        </div>

        <!-- Complexity Triggers -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">محفزات التعقيد (توصية الخبير)</h3>
          <p class="text-gray-500 text-sm mb-4">عند تحقق أي من هذه الشروط، سيتم عرض تنبيه للمستخدم بالاستعانة بخبير</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">حد القيمة المالية (د.ك)</label>
              <input type="number" id="financialThreshold" value="5000" class="w-full px-4 py-3 rounded-xl border border-gray-200">
              <p class="text-xs text-gray-500 mt-1">العقود أعلى من هذا المبلغ ستظهر تنبيه</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">حد ثقة الذكاء الاصطناعي (%)</label>
              <input type="number" id="aiConfidenceThreshold" value="85" min="0" max="100" class="w-full px-4 py-3 rounded-xl border border-gray-200">
              <p class="text-xs text-gray-500 mt-1">إذا كانت الثقة أقل من هذا سيتم التوصية بخبير</p>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">الكلمات الحساسة (فاصلة بين كل كلمة)</label>
            <input type="text" id="sensitiveKeywords" value="تحكيم, نزاع, دولي, غرامة, ضمان, Arbitration, Dispute, International" class="w-full px-4 py-3 rounded-xl border border-gray-200">
          </div>
          <button onclick="saveComplexitySettings()" class="mt-4 gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">حفظ المحفزات</button>
        </div>

        <!-- Blur Settings -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إعدادات الضبابية (للمستخدمين المجانيين)</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div>
                <p class="font-medium text-gray-800">تفعيل الضبابية</p>
                <p class="text-sm text-gray-500">إخفاء تفاصيل المشاكل الحرجة للمستخدمين المجانيين</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="blurEnabled" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
              <div>
                <p class="font-medium text-gray-800">عرض عدد المشاكل</p>
                <p class="text-sm text-gray-500">إظهار عدد المشاكل المكتشفة بدون التفاصيل</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="showIssueCount" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <button onclick="saveBlurSettings()" class="mt-4 gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">حفظ الإعدادات</button>
        </div>
      </section>

      <!-- Vendors Marketplace Section -->
      <section id="vendors-section" class="hidden">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-2xl font-bold text-gray-800">سوق الخبراء</h2>
            <p class="text-gray-500 mt-1">إدارة شركاء الخبراء والمكاتب المعتمدة</p>
          </div>
          <div class="flex gap-3">
            <a href="partner.html" target="_blank" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
              بوابة الشريك
            </a>
            <button onclick="showAddVendorModal()" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              إضافة شريك
            </button>
          </div>
        </div>

        <!-- Vendors Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <p class="text-3xl font-bold text-gray-800" id="stat-vendors">0</p>
            <p class="text-gray-500 text-sm mt-1">إجمالي الشركاء</p>
          </div>
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <p class="text-3xl font-bold text-green-600" id="stat-active-vendors">0</p>
            <p class="text-gray-500 text-sm mt-1">شركاء نشطون</p>
          </div>
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <p class="text-3xl font-bold text-blue-600" id="stat-orders">0</p>
            <p class="text-gray-500 text-sm mt-1">إجمالي الطلبات</p>
          </div>
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <p class="text-3xl font-bold text-[#8B1538]" id="stat-revenue">0 د.ك</p>
            <p class="text-gray-500 text-sm mt-1">إيرادات المنصة</p>
          </div>
        </div>

        <!-- Pending Applications -->
        <div id="pendingApplicationsSection" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6 hidden">
          <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></span>
            طلبات الانضمام المعلقة
          </h3>
          <div id="pendingApplicationsList" class="space-y-3"></div>
        </div>

        <!-- Vendors Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">الشريك</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">التخصص</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">التقييم</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">الطلبات</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">الحالة</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">إجراءات</th>
              </tr>
            </thead>
            <tbody id="vendorsTableBody" class="divide-y divide-gray-100">
              <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">لا يوجد شركاء بعد</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Send Notifications Section -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
            إرسال إشعارات للشركاء
          </h3>
          <form id="vendorNotificationForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">إرسال إلى</label>
              <select id="notificationTarget" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="all">جميع الشركاء</option>
                <option value="active">الشركاء النشطون فقط</option>
                <option value="specific">شريك محدد</option>
              </select>
            </div>
            <div id="specificVendorSelect" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">اختر الشريك</label>
              <select id="selectedVendorId" class="w-full px-4 py-3 rounded-xl border border-gray-200"></select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">عنوان الإشعار</label>
              <input type="text" id="notificationTitle" class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="عنوان الإشعار" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">محتوى الإشعار</label>
              <textarea id="notificationMessage" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none" placeholder="اكتب رسالتك هنا..." required></textarea>
            </div>
            <button type="submit" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90 transition flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
              إرسال الإشعار
            </button>
          </form>
        </div>

        <!-- Withdrawal Requests Section -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            طلبات السحب
          </h3>
          <div id="withdrawalRequestsList" class="space-y-3">
            <p class="text-gray-500 text-center py-4">لا توجد طلبات سحب حالياً</p>
          </div>
        </div>

        <!-- Platform Earnings Report -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-[#8B1538]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            تقرير أرباح المنصة
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-green-50 rounded-xl p-4">
              <p class="text-sm text-green-600 mb-1">إجمالي الإيرادات</p>
              <p class="text-2xl font-bold text-green-700" id="totalRevenue">0 د.ك</p>
            </div>
            <div class="bg-blue-50 rounded-xl p-4">
              <p class="text-sm text-blue-600 mb-1">حصة الشركاء (70%)</p>
              <p class="text-2xl font-bold text-blue-700" id="partnersShare">0 د.ك</p>
            </div>
            <div class="bg-[#8B1538] bg-opacity-10 rounded-xl p-4">
              <p class="text-sm text-[#8B1538] mb-1">حصة المنصة (30%)</p>
              <p class="text-2xl font-bold text-[#8B1538]" id="platformShare">0 د.ك</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Notification Template Modal -->
  <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
      <h3 class="text-lg font-bold text-gray-800 mb-4">تعديل قالب الإشعار</h3>
      <form id="templateForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">عنوان البريد</label>
          <input type="text" id="templateSubject" class="w-full px-4 py-3 rounded-xl border border-gray-200">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">محتوى البريد</label>
          <textarea id="templateBody" rows="6" class="w-full px-4 py-3 rounded-xl border border-gray-200 resize-none"></textarea>
          <p class="text-xs text-gray-500 mt-1">المتغيرات المتاحة: {{name}}, {{email}}, {{package}}, {{date}}</p>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 gradient-bg text-white py-3 rounded-xl font-semibold">حفظ</button>
          <button type="button" onclick="closeTemplateModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold">إلغاء</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Always point to backend API (fixes live-server 404/MIME issues)
    const API_BASE = "http://localhost:3000";

    // Show Notification Function
    function showNotification(message, type = 'info') {
      // Remove existing notifications
      const existing = document.querySelector('.notification-toast');
      if (existing) existing.remove();
      
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-amber-500',
        info: 'bg-blue-500'
      };
      
      const icons = {
        success: '✓',
        error: '✗',
        warning: '⚠',
        info: 'ℹ'
      };
      
      const notification = document.createElement('div');
      notification.className = `notification-toast fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg z-[9999] flex items-center gap-3 animate-pulse`;
      notification.innerHTML = `
        <span class="text-xl">${icons[type]}</span>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="mr-4 hover:opacity-80">✕</button>
      `;
      
      document.body.appendChild(notification);
      
      // Auto remove after 5 seconds
      setTimeout(() => notification.remove(), 5000);
    }

    // ===== Partner Applications (Admin) =====
    async function loadPartnerApplications() {
      const table = document.getElementById('partnerApplicationsBody');
      if (!table) return;
      table.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">جاري التحميل...</td></tr>';
      try {
        const apps = await trpc("POST", "partnerApplications.list", {});
        if (!apps || apps.length === 0) {
          table.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">لا توجد طلبات شراكة</td></tr>';
          return;
        }
        table.innerHTML = "";
        apps.forEach((a) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-6 py-4 text-sm text-gray-700">${a.id}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${a.fullName || "-"}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${a.email}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${a.status}</td>
            <td class="px-6 py-4 text-sm text-gray-700 space-x-2 space-x-reverse">
              <button class="text-green-600 hover:underline" onclick="approvePartnerApplication(${a.id})">موافقة</button>
              <button class="text-red-600 hover:underline" onclick="rejectPartnerApplication(${a.id})">رفض</button>
            </td>
          `;
          table.appendChild(tr);
        });
      } catch (e) {
        table.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-600">فشل في تحميل الطلبات</td></tr>';
        console.error(e);
      }
    }

    async function approvePartnerApplication(applicationId) {
      try {
        await trpc("POST", "partnerApplications.approve", { applicationId });
        showNotification('تمت الموافقة على الطلب', 'success');
        loadPartnerApplications();
      } catch (e) {
        showNotification(e.message || 'فشل في الموافقة على الطلب', 'error');
      }
    }

    async function rejectPartnerApplication(applicationId) {
      try {
        await trpc("POST", "partnerApplications.reject", { applicationId });
        showNotification('تم رفض الطلب', 'success');
        loadPartnerApplications();
      } catch (e) {
        showNotification(e.message || 'فشل في رفض الطلب', 'error');
      }
    }

    // ===== Notifications (Admin) =====
    async function loadNotifications() {
      const list = document.getElementById('notificationsList');
      if (!list) return;
      list.innerHTML = '<div class="p-6 text-center text-gray-500">جاري التحميل...</div>';
      try {
        const rows = await trpc("POST", "notifications.adminList", { limit: 50 });
        if (!rows || rows.length === 0) {
          list.innerHTML = '<div class="p-6 text-center text-gray-500">لا توجد إشعارات</div>';
          return;
        }
        list.innerHTML = "";
        rows.forEach((n) => {
          const div = document.createElement("div");
          div.className = `p-4 border-b border-gray-100 ${n.status === 'read' ? 'opacity-60' : ''}`;
          const date = n.createdAt ? new Date(n.createdAt).toLocaleDateString('ar-SA') : '';
          div.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="font-semibold text-gray-800">${n.title || '-'}</p>
                <p class="text-sm text-gray-600 mt-1">${n.body || '-'}</p>
                <p class="text-xs text-gray-400 mt-1">${date}</p>
              </div>
              <span class="text-xs px-2 py-1 rounded ${n.status === 'read' ? 'bg-gray-100 text-gray-600' : 'bg-blue-100 text-blue-600'}">${n.status === 'read' ? 'مقروء' : 'غير مقروء'}</span>
            </div>
          `;
          list.appendChild(div);
        });
      } catch (e) {
        list.innerHTML = '<div class="p-6 text-center text-red-600">فشل في تحميل الإشعارات: ' + (e.message || 'خطأ غير معروف') + '</div>';
        console.error('Error loading notifications:', e);
      }
    }

    async function markNotificationsRead() {
      try {
        await trpc("POST", "notifications.adminMarkAllRead");
        showNotification('تم تحديث جميع الإشعارات كمقروءة', 'success');
        loadNotifications();
      } catch (e) {
        showNotification(e.message || 'فشل في تحديث الإشعارات', 'error');
        console.error('Error marking notifications read:', e);
      }
    }

    // ===== Escrow UI helpers =====
    function getConsultationUIState(status) {
      const map = {
        pending_advisor: "بانتظار المستشار",
        accepted: "تم القبول، بانتظار الدفع",
        payment_reserved: "تم حجز الدفع (إسكرو)",
        in_progress: "جلسة جارية",
        completed: "بانتظار التحرير",
        released: "تم التحرير",
        cancelled: "ملغاة",
      };
      return map[status] || status || "-";
    }

    function canUploadFiles(consultationStatus) {
      return consultationStatus === "in_progress";
    }

    // Login using backend API
    let adminToken = null;
    let currentUser = null;
    
    // Initialize tRPC client
    const trpcClient = new TRPCClient(API_BASE, () => adminToken);
    
    // Helper function for tRPC calls
    async function trpc(method, path, input) {
      return trpcClient.request(path, input, method);
    }
    
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const emailInput = document.getElementById('adminEmail');
      const passwordInput = document.getElementById('adminPassword');
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const errorEl = document.getElementById('loginError');
      
      // Clear previous errors
      errorEl.classList.add('hidden');
      errorEl.textContent = '';
      
      // Validate inputs
      if (!email || !password) {
        errorEl.textContent = "يرجى إدخال البريد الإلكتروني وكلمة المرور";
        errorEl.classList.remove('hidden');
        return;
      }
      
      // Disable form during request
      emailInput.disabled = true;
      passwordInput.disabled = true;
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('input[type="submit"]');
      const originalBtnText = submitBtn?.textContent || submitBtn?.value;
      if (submitBtn) {
        submitBtn.disabled = true;
        if (submitBtn.textContent !== undefined) {
          submitBtn.textContent = "جاري تسجيل الدخول...";
        } else if (submitBtn.value !== undefined) {
          submitBtn.value = "جاري تسجيل الدخول...";
        }
      }
      
      try {
        console.log('[Admin Login] Attempting login for:', email);
        const data = await trpc("POST", "auth.login", { email, password });
        console.log('[Admin Login] Response received:', data);
        
        // Check response format - server returns { success, token, user }
        if (!data) {
          throw new Error("لم يتم استلام أي بيانات من الخادم");
        }
        
        const token = data.token || data.data?.token;
        const user = data.user || data.data?.user;
        
        if (!token || !user) {
          console.error('[Admin Login] Missing token or user:', { token: !!token, user: !!user, data });
          throw new Error("لم يتم استلام رمز الدخول أو بيانات المستخدم");
        }
        
        // Check if user is admin
        if (user.role !== 'admin') {
          throw new Error("هذا الحساب ليس حساب مشرف");
        }
        
        // Success - save token in memory and redirect
        adminToken = token;
        currentUser = user;
        console.log('[Admin Login] Login successful, redirecting to dashboard');
        
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        await loadDashboardData();
        initCharts();
      } catch (error) {
        console.error('[Admin Login] Error:', error);
        const errorMessage = error.message || "بيانات الدخول غير صحيحة";
        errorEl.textContent = errorMessage;
        errorEl.classList.remove('hidden');
        
        // Keep form values on error
        emailInput.value = email;
        passwordInput.value = password;
      } finally {
        // Re-enable form
        emailInput.disabled = false;
        passwordInput.disabled = false;
        if (submitBtn) {
          submitBtn.disabled = false;
          if (submitBtn.textContent !== undefined) {
            submitBtn.textContent = originalBtnText || "تسجيل الدخول";
          } else if (submitBtn.value !== undefined) {
            submitBtn.value = originalBtnText || "تسجيل الدخول";
          }
        }
      }
    });
    
    // Check token on load without localStorage fallback
    (async function init() {
      try {
        const user = await trpc("GET", "auth.me");
        if (user && user.role === 'admin') {
          currentUser = user;
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          await loadDashboardData();
          await loadPartnerApplications();
          await loadNotifications();
          await loadPaymentSettings();
          initCharts();
        } else {
          adminToken = null;
        }
      } catch (e) {
        adminToken = null;
      }
    })();

    async function handleLogout() {
      try {
        await trpc("POST", "auth.logout");
      } catch (e) {
        // Ignore logout errors
      }
      adminToken = null;
      currentUser = null;
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    }

    function showSection(sectionId, event) {
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
      document.querySelectorAll('.sidebar-item').forEach(btn => btn.classList.remove('active'));
      if (event) event.currentTarget.classList.add('active');
    }

    // Load Dashboard Data
    async function loadDashboardData() {
      try {
        const data = await trpc("POST", "admin.stats");
        if (data) {
          document.getElementById('stat-users').textContent = data.usersCount || 0;
          document.getElementById('stat-conversations').textContent = data.conversationsCount || 0;
          document.getElementById('stat-contracts').textContent = data.contractsCount || 0;
          document.getElementById('stat-stocks').textContent = data.stocksScreened || 0;
        }
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Show error state instead of mock data
        document.getElementById('stat-users').textContent = '—';
        document.getElementById('stat-conversations').textContent = '—';
        document.getElementById('stat-contracts').textContent = '—';
        document.getElementById('stat-stocks').textContent = '—';
        showNotification('فشل في تحميل بيانات لوحة التحكم', 'error');
      }
    }

    // Charts
    function initCharts() {
      // Usage Chart
      const usageCtx = document.getElementById('usageChart')?.getContext('2d');
      if (usageCtx) {
        new Chart(usageCtx, {
          type: 'line',
          data: {
            labels: ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'],
            datasets: [{
              label: 'المحادثات',
              data: [120, 190, 170, 220, 280, 250, 310],
              borderColor: '#8B1538',
              backgroundColor: 'rgba(139, 21, 56, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
      }

      // Category Chart
      const categoryCtx = document.getElementById('categoryChart')?.getContext('2d');
      if (categoryCtx) {
        new Chart(categoryCtx, {
          type: 'doughnut',
          data: {
            labels: ['الأسهم', 'العقود', 'البنوك', 'الصكوك', 'أخرى'],
            datasets: [{
              data: [35, 25, 20, 12, 8],
              backgroundColor: ['#8B1538', '#C9375D', '#D4A574', '#2D5016', '#687076']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
    }

    // File Upload
    const dropZone = document.getElementById('fileDropZone');
    if (dropZone) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) handleFileUpload(files[0]);
      });
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) handleFileUpload(file);
    }

    async function handleFileUpload(file) {
      const allowedTypes = ['application/pdf', 'text/plain', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      if (!allowedTypes.includes(file.type)) {
        alert('نوع الملف غير مدعوم. يرجى رفع PDF, TXT, DOC, أو DOCX');
        return;
      }

      document.getElementById('uploadProgress').classList.remove('hidden');
      document.getElementById('uploadFileName').textContent = file.name;
      
      // Simulate upload progress
      let progress = 0;
      const progressBar = document.getElementById('uploadProgressBar');
      const interval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        if (progress >= 100) {
          clearInterval(interval);
          document.getElementById('uploadProgress').classList.add('hidden');
          document.getElementById('aiProcessing').classList.remove('hidden');
          
          // Simulate AI processing
          setTimeout(() => {
            document.getElementById('aiProcessing').classList.add('hidden');
            alert('تم رفع ومعالجة الملف بنجاح!');
            loadDocuments();
          }, 3000);
        }
      }, 200);
    }

    function loadDocuments() {
      const list = document.getElementById('documentsList');
      if (list) {
        list.innerHTML = `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
              </div>
              <div>
                <p class="font-medium text-gray-800">معايير أيوفي للمرابحة.pdf</p>
                <p class="text-sm text-gray-500">فتوى • 2.3 MB • تمت المعالجة</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs">مفهرس</span>
              <button class="text-red-500 hover:bg-red-50 p-2 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>
          </div>
        `;
      }
    }

    // News Tabs
    function showNewsTab(tab) {
      document.querySelectorAll('[id^="news-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById('news-' + tab).classList.remove('hidden');
      document.querySelectorAll('#news-section .tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('bg-gray-100', 'text-gray-600');
      });
      event.currentTarget.classList.add('active');
      event.currentTarget.classList.remove('bg-gray-100', 'text-gray-600');
    }

    function handleNewsImageSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('newsImagePreview').classList.remove('hidden');
          document.getElementById('newsImagePreviewImg').src = e.target.result;
          document.getElementById('newsImageIcon').classList.add('hidden');
        };
        reader.readAsDataURL(file);
      }
    }

    // AI Tabs
    function showAITab(tab) {
      document.querySelectorAll('[id^="ai-"]').forEach(el => {
        if (el.id !== 'ai-section') el.classList.add('hidden');
      });
      document.getElementById('ai-' + tab).classList.remove('hidden');
      document.querySelectorAll('#ai-section .tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('bg-gray-100', 'text-gray-600');
      });
      event.currentTarget.classList.add('active');
      event.currentTarget.classList.remove('bg-gray-100', 'text-gray-600');
    }

    // Users
    async function loadUsers() {
      const tbody = document.getElementById('usersTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">جاري التحميل...</td></tr>';
      
      try {
        const users = await trpc("GET", "admin.users") || [];
        
        // Update stats
        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'active').length;
        document.getElementById('proUsers').textContent = users.filter(u => u.tier === 'pro').length;
        document.getElementById('enterpriseUsers').textContent = users.filter(u => u.tier === 'enterprise').length;
        
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">لا يوجد مستخدمين حتى الآن</td></tr>';
          return;
        }
        
        const roleColors = {
          user: 'bg-blue-100 text-blue-700',
          consultant: 'bg-purple-100 text-purple-700',
          admin: 'bg-red-100 text-red-700'
        };
        
        const tierColors = {
          free: 'bg-gray-100 text-gray-700',
          pro: 'bg-amber-100 text-amber-700',
          enterprise: 'bg-purple-100 text-purple-700'
        };
        
        const statusColors = {
          active: 'bg-green-100 text-green-700',
          inactive: 'bg-gray-100 text-gray-700',
          suspended: 'bg-red-100 text-red-700'
        };
        
        const roleLabels = { user: 'مستخدم', consultant: 'مستشار', admin: 'مشرف' };
        const tierLabels = { free: 'مجاني', pro: 'Pro', enterprise: 'Enterprise' };
        const statusLabels = { active: 'نشط', inactive: 'غير نشط', suspended: 'موقوف' };
        
        tbody.innerHTML = users.map(user => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                  <span class="text-gray-600 font-medium">${(user.name || 'م')[0]}</span>
                </div>
                <div>
                  <p class="font-medium text-gray-800">${user.name || 'بدون اسم'}</p>
                  <p class="text-sm text-gray-500">${user.email}</p>
                </div>
              </div>
            </td>
            <td class="px-6 py-4"><span class="px-3 py-1 ${roleColors[user.role] || roleColors.user} rounded-full text-xs">${roleLabels[user.role] || 'مستخدم'}</span></td>
            <td class="px-6 py-4"><span class="px-3 py-1 ${tierColors[user.tier] || tierColors.free} rounded-full text-xs">${tierLabels[user.tier] || 'مجاني'}</span></td>
            <td class="px-6 py-4"><span class="px-3 py-1 ${statusColors[user.status] || statusColors.active} rounded-full text-xs">${statusLabels[user.status] || 'نشط'}</span></td>
            <td class="px-6 py-4">
              <button onclick="editUser(${user.id})" class="text-[#8B1538] hover:bg-[#8B1538] hover:bg-opacity-10 px-3 py-1 rounded-lg text-sm">تعديل</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error loading users:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">حدث خطأ في تحميل المستخدمين</td></tr>';
      }
    }

    function editUser(userId) {
      document.getElementById('userModal').classList.remove('hidden');
    }

    // Consultants
    async function loadConsultants() {
      const tbody = document.getElementById('consultantsTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">جاري التحميل...</td></tr>';
      
      try {
        const consultants = await trpc("POST", "consultants.list") || [];
        
        if (consultants.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">لا يوجد مستشارين حتى الآن</td></tr>';
          return;
        }
        
        const specialtyLabels = {
          stocks: 'الأسهم والاستثمارات',
          contracts: 'العقود والمعاملات',
          banking: 'البنوك الإسلامية',
          sukuk: 'الصكوك',
          general: 'عام'
        };
        
        tbody.innerHTML = consultants.map(c => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                  <span class="text-purple-600 font-medium">${(c.name || 'م')[0]}</span>
                </div>
                <div>
                  <p class="font-medium text-gray-800">${c.name}</p>
                  <p class="text-sm text-gray-500">${c.email}</p>
                </div>
              </div>
            </td>
            <td class="px-6 py-4"><span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs">${specialtyLabels[c.specialty] || c.specialty}</span></td>
            <td class="px-6 py-4 text-center">${c.activeChats || 0}</td>
            <td class="px-6 py-4"><span class="px-3 py-1 ${c.status === 'available' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'} rounded-full text-xs">${c.status === 'available' ? 'متاح' : 'مشغول'}</span></td>
            <td class="px-6 py-4">
              <button onclick="editConsultant(${c.id})" class="text-[#8B1538] hover:bg-[#8B1538] hover:bg-opacity-10 px-3 py-1 rounded-lg text-sm">تعديل</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error loading consultants:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">حدث خطأ في تحميل المستشارين</td></tr>';
      }
    }

    function editConsultant(consultantId) {
      showNotification('سيتم إضافة نافذة التعديل قريباً', 'info');
    }

    function closeUserModal() {
      document.getElementById('userModal').classList.add('hidden');
    }

    // Notification Templates
    function editNotificationTemplate(type) {
      const templates = {
        registration: { subject: 'مرحباً بك في خبير!', body: 'مرحباً {{name}}،\n\nشكراً لتسجيلك في منصة خبير...' },
        purchase: { subject: 'تأكيد الاشتراك', body: 'مرحباً {{name}}،\n\nتم تفعيل باقة {{package}} بنجاح...' },
        cart: { subject: 'أكمل اشتراكك', body: 'مرحباً {{name}}،\n\nلاحظنا أنك لم تكمل عملية الاشتراك...' }
      };
      const template = templates[type] || { subject: '', body: '' };
      document.getElementById('templateSubject').value = template.subject;
      document.getElementById('templateBody').value = template.body;
      document.getElementById('templateModal').classList.remove('hidden');
    }

    function closeTemplateModal() {
      document.getElementById('templateModal').classList.add('hidden');
    }

    // Save functions
    function saveConversationSettings() {
      alert('تم حفظ إعدادات المحادثة بنجاح!');
    }

    function saveSourceSettings() {
      alert('تم حفظ إعدادات المصادر بنجاح!');
    }

    function savePersonalitySettings() {
      alert('تم حفظ إعدادات الشخصية بنجاح!');
    }

    function saveNewsAutomation() {
      alert('تم حفظ إعدادات أتمتة الأخبار بنجاح!');
    }

    function addNewsSource() {
      const input = document.getElementById('newRssSource');
      if (input.value) {
        alert('تمت إضافة المصدر: ' + input.value);
        input.value = '';
      }
    }

    async function syncNewsNow() {
      const btn = document.getElementById('syncNewsBtn');
      const btnText = document.getElementById('syncNewsBtnText');
      const status = document.getElementById('syncNewsStatus');
      
      btn.disabled = true;
      btnText.textContent = 'جاري المزامنة...';
      status.classList.remove('hidden');
      status.innerHTML = '<span class="text-blue-600">⏳ جاري جلب الأخبار من NewsAPI و AAOIFI...</span>';
      
      try {
        const result = await trpc("POST", "news.sync", {});
        const apiAdded = result?.api?.added || 0;
        const apiSkipped = result?.api?.skipped || 0;
        const aaoifiAdded = result?.aaoifi?.added || 0;
        const aaoifiSkipped = result?.aaoifi?.skipped || 0;
        const total = apiAdded + aaoifiAdded;
        
        status.innerHTML = `
          <span class="text-green-600 font-medium">✅ تمت المزامنة بنجاح!</span>
          <div class="mt-2 text-sm text-gray-600">
            <p>📰 NewsAPI: ${apiAdded} جديد، ${apiSkipped} موجود مسبقاً</p>
            <p>📜 AAOIFI: ${aaoifiAdded} جديد، ${aaoifiSkipped} موجود مسبقاً</p>
            <p class="font-medium mt-1">📊 إجمالي: ${total} مقال جديد</p>
          </div>
        `;
        
        showNotification(`تمت إضافة ${total} مقال جديد بنجاح!`, 'success');
      } catch (error) {
        console.error('Sync error:', error);
        status.innerHTML = `<span class="text-red-600">❌ فشلت المزامنة: ${error.message || 'خطأ غير معروف'}</span>`;
        showNotification('فشلت عملية المزامنة', 'error');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'مزامنة الآن';
      }
    }

    // Forms
    document.getElementById('newsForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      alert('تم نشر الخبر بنجاح!');
    });

    document.getElementById('consultantForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'جاري الإضافة...';
      submitBtn.disabled = true;
      
      const consultantData = {
        name: document.getElementById('consultantName').value,
        email: document.getElementById('consultantEmail').value,
        specialty: document.getElementById('consultantSpecialty').value,
        maxChatsPerDay: parseInt(document.getElementById('consultantMaxChats')?.value || '10')
      };
      
      try {
        await trpc("POST", "consultants.create", consultantData);
        showNotification('تمت إضافة المستشار بنجاح!', 'success');
        e.target.reset();
        loadConsultants();
      } catch (error) {
        console.error('Error adding consultant:', error);
        showNotification('عذراً، حدث خطأ أثناء إضافة المستشار: ' + error.message, 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    document.getElementById('broadcastForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn?.textContent || 'إرسال الإشعار';
      
      const title = document.getElementById('broadcastTitle')?.value?.trim();
      const body = document.getElementById('broadcastBody')?.value?.trim();
      const target = document.getElementById('broadcastTarget')?.value || 'all';
      
      if (!title || !body) {
        showNotification('يرجى إدخال العنوان والمحتوى', 'error');
        return;
      }
      
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'جاري الإرسال...';
      }
      
      try {
        const result = await trpc("POST", "notifications.broadcast", {
          title,
          body,
          target,
        });
        showNotification(`تم إرسال الإشعار بنجاح إلى ${result.sentCount || 0} مستخدم`, 'success');
        form.reset();
      } catch (error) {
        showNotification(error.message || 'فشل في إرسال الإشعار', 'error');
        console.error('Error broadcasting notification:', error);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }
    });

    document.getElementById('apiKeyForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      alert('تم إنشاء مفتاح API بنجاح!');
    });

    document.getElementById('userEditForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      closeUserModal();
      alert('تم تحديث المستخدم بنجاح!');
    });

    document.getElementById('templateForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      closeTemplateModal();
      alert('تم حفظ القالب بنجاح!');
    });

    // Payment Gateway Functions
    async function saveMyfatoorah() {
      const token = document.getElementById('myfatoorahToken')?.value?.trim();
      const enabled = document.getElementById('myfatoorahEnabled')?.checked || false;
      const environment = document.getElementById('myfatoorahEnvironment')?.value || 'sandbox';
      
      if (!token && enabled) {
        showNotification('يرجى إدخال API Token', 'error');
        return;
      }
      
      try {
        await trpc("POST", "system.updatePaymentSettings", {
          gateway: "myfatoorah",
          settings: {
            enabled: enabled.toString(),
            token: token || "",
            environment: environment,
          },
        });
        showNotification('تم حفظ إعدادات ماي فاتورة بنجاح', 'success');
      } catch (error) {
        showNotification(error.message || 'فشل في حفظ الإعدادات', 'error');
        console.error('Error saving MyFatoorah settings:', error);
      }
    }

    async function saveStripe() {
      const publicKey = document.getElementById('stripePublicKey')?.value?.trim();
      const secretKey = document.getElementById('stripeSecretKey')?.value?.trim();
      const enabled = document.getElementById('stripeEnabled')?.checked || false;
      
      if (enabled && (!publicKey || !secretKey)) {
        showNotification('يرجى إدخال جميع المفاتيح', 'error');
        return;
      }
      
      try {
        await trpc("POST", "system.updatePaymentSettings", {
          gateway: "stripe",
          settings: {
            enabled: enabled.toString(),
            publicKey: publicKey || "",
            secretKey: secretKey || "",
          },
        });
        showNotification('تم حفظ إعدادات Stripe بنجاح', 'success');
      } catch (error) {
        showNotification(error.message || 'فشل في حفظ الإعدادات', 'error');
        console.error('Error saving Stripe settings:', error);
      }
    }

    async function saveTap() {
      const secretKey = document.getElementById('tapSecretKey')?.value?.trim();
      const enabled = document.getElementById('tapEnabled')?.checked || false;
      
      if (enabled && !secretKey) {
        showNotification('يرجى إدخال Secret Key', 'error');
        return;
      }
      
      try {
        await trpc("POST", "system.updatePaymentSettings", {
          gateway: "tap",
          settings: {
            enabled: enabled.toString(),
            secretKey: secretKey || "",
          },
        });
        showNotification('تم حفظ إعدادات Tap Payments بنجاح', 'success');
      } catch (error) {
        showNotification(error.message || 'فشل في حفظ الإعدادات', 'error');
        console.error('Error saving Tap settings:', error);
      }
    }

    // Load payment settings on page load
    async function loadPaymentSettings() {
      try {
        const settings = await trpc("POST", "system.getPaymentSettings");
        if (settings) {
          // MyFatoorah
          if (settings.myfatoorah) {
            document.getElementById('myfatoorahEnabled').checked = settings.myfatoorah.enabled || false;
            document.getElementById('myfatoorahToken').value = settings.myfatoorah.token || '';
            const envSelect = document.getElementById('myfatoorahEnvironment');
            if (envSelect && settings.myfatoorah.environment) {
              envSelect.value = settings.myfatoorah.environment;
            }
          }
          // Stripe
          if (settings.stripe) {
            document.getElementById('stripeEnabled').checked = settings.stripe.enabled || false;
            document.getElementById('stripePublicKey').value = settings.stripe.publicKey || '';
            document.getElementById('stripeSecretKey').value = settings.stripe.secretKey || '';
          }
          // Tap
          if (settings.tap) {
            document.getElementById('tapEnabled').checked = settings.tap.enabled || false;
            document.getElementById('tapSecretKey').value = settings.tap.secretKey || '';
          }
          // In-App
          if (settings.inApp) {
            document.getElementById('inAppEnabled').checked = settings.inApp.enabled !== false;
          }
        }
      } catch (error) {
        console.error('Error loading payment settings:', error);
        // Don't show error to user on initial load
      }
    }

    // Privacy & Terms Functions
    function savePrivacyPolicy() {
      const content = document.getElementById('privacyPolicy').value;
      alert('تم حفظ سياسة الخصوصية بنجاح!');
    }

    function saveTermsOfService() {
      const content = document.getElementById('termsOfService').value;
      alert('تم حفظ الشروط والأحكام بنجاح!');
    }

    // Add User Form
    document.getElementById('addUserForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'جاري الإضافة...';
      submitBtn.disabled = true;
      
      const packageValue = document.getElementById('newUserPackage').value;
      const isFreePackage = document.getElementById('newUserFreePackage')?.checked || false;
      
      const userData = {
        email: document.getElementById('newUserEmail').value,
        password: document.getElementById('newUserPassword').value,
        role: document.getElementById('newUserRole').value || 'user',
      };
      
      try {
        await trpc("POST", "auth.register", userData);
        showNotification('تم إضافة المستخدم بنجاح!', 'success');
        e.target.reset();
        loadUsers();
      } catch (error) {
        showNotification('عذراً، فشل في إضافة المستخدم: ' + (error.message || ''), 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // Save Daily Limits (Note: These are managed via tier_limits table, not localStorage)
    function saveDailyLimits() {
      showNotification('حدود الاستخدام يتم إدارتها عبر جدول tier_limits في قاعدة البيانات. يرجى استخدام واجهة إدارة الخطط.', 'info');
    }

    // Load saved daily limits
    function loadDailyLimits() {
      const freeDailyLimit = localStorage.getItem('freeDailyLimit') || '5';
      const guestDailyLimit = localStorage.getItem('guestDailyLimit') || '3';
      
      if (document.getElementById('freeDailyLimit')) {
        document.getElementById('freeDailyLimit').value = freeDailyLimit;
      }
      if (document.getElementById('guestDailyLimit')) {
        document.getElementById('guestDailyLimit').value = guestDailyLimit;
      }
    }

    // Package Form - DISABLED (no backend support yet)
    // Custom packages feature requires backend table - disabled until implemented
    let customPackages = [];
    
    document.getElementById('packageForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      showNotification('ميزة الباقات المخصصة غير متاحة حالياً. تتطلب إعدادات خلفية.', 'warning');
      return;
      e.preventDefault();
      const form = e.target;
      const inputs = form.querySelectorAll('input[type="text"], input[type="number"]');
      const checkboxes = form.querySelectorAll('input[type="checkbox"]');
      const select = form.querySelector('select');
      
      const packageName = inputs[0]?.value || '';
      const packagePrice = inputs[1]?.value || '0';
      const packageQuestions = inputs[2]?.value || '0';
      const packageDuration = select?.value || 'شهري';
      
      if (!packageName) {
        showNotification('يرجى إدخال اسم الباقة', 'error');
        return;
      }
      
      const features = [];
      checkboxes.forEach((cb, index) => {
        const featureNames = ['محادثات AI', 'فحص الأسهم', 'تحليل العقود', 'استشارة مستشار', 'تقارير مفصلة', 'أولوية الدعم'];
        features.push({ name: featureNames[index], enabled: cb.checked });
      });
      
      const newPackage = {
        id: Date.now(),
        name: packageName,
        price: parseFloat(packagePrice),
        questions: parseInt(packageQuestions),
        duration: packageDuration,
        features: features,
        status: 'active',
        createdAt: new Date().toISOString()
      };
      
      // DISABLED: No backend support
      // customPackages.push(newPackage);
      // localStorage.setItem('khabeer_custom_packages', JSON.stringify(customPackages));
      
      // Add to UI
      renderCustomPackages();
      
      // Reset form
      form.reset();
      showNotification('تم إنشاء الباقة "' + packageName + '" بنجاح!', 'success');
    });
    
    function renderCustomPackages() {
      const container = document.querySelector('#packages-section .grid.grid-cols-3');
      if (!container) return;
      
      // Remove old custom packages
      container.querySelectorAll('.custom-package').forEach(el => el.remove());
      
      // Add custom packages
      customPackages.forEach(pkg => {
        const packageCard = document.createElement('div');
        packageCard.className = 'custom-package border border-gray-200 rounded-2xl p-6';
        packageCard.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-bold text-lg">${pkg.name}</h4>
            <span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-sm">مخصص</span>
          </div>
          <p class="text-3xl font-bold text-gray-800 mb-4">${pkg.price} <span class="text-sm font-normal text-gray-500">ريال/${pkg.duration}</span></p>
          <ul class="space-y-2 text-sm text-gray-600 mb-4">
            <li class="flex items-center gap-2">✅ ${pkg.questions} سؤال/${pkg.duration}</li>
            ${pkg.features.map(f => `<li class="flex items-center gap-2">${f.enabled ? '✅' : '❌'} ${f.name}</li>`).join('')}
          </ul>
          <div class="flex gap-2">
            <button onclick="editPackage(${pkg.id})" class="flex-1 py-2 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50">تعديل</button>
            <button onclick="deletePackage(${pkg.id})" class="py-2 px-4 bg-red-50 text-red-600 rounded-xl hover:bg-red-100">حذف</button>
          </div>
        `;
        container.appendChild(packageCard);
      });
    }
    
    function deletePackage(id) {
      if (confirm('هل أنت متأكد من حذف هذه الباقة؟')) {
        // DISABLED: No backend support
        // customPackages = customPackages.filter(p => p.id !== id);
        // localStorage.setItem('khabeer_custom_packages', JSON.stringify(customPackages));
        renderCustomPackages();
        showNotification('تم حذف الباقة بنجاح', 'success');
      }
    }
    
    function editPackage(id) {
      const pkg = customPackages.find(p => p.id === id);
      if (!pkg) return;
      
      const form = document.getElementById('packageForm');
      const inputs = form.querySelectorAll('input[type="text"], input[type="number"]');
      const checkboxes = form.querySelectorAll('input[type="checkbox"]');
      
      inputs[0].value = pkg.name;
      inputs[1].value = pkg.price;
      inputs[2].value = pkg.questions;
      
      pkg.features.forEach((f, i) => {
        if (checkboxes[i]) checkboxes[i].checked = f.enabled;
      });
      
      // Remove from list for re-add on submit
      customPackages = customPackages.filter(p => p.id !== id);
      localStorage.setItem('khabeer_custom_packages', JSON.stringify(customPackages));
      renderCustomPackages();
      
      showNotification('تم تحميل الباقة للتعديل', 'info');
      
      // Scroll to form
      form.scrollIntoView({ behavior: 'smooth' });
    }

    // Edit Default Package Function
    function editDefaultPackage(packageType) {
      const packageData = {
        free: { name: 'مجاني', price: 0, questions: 10 },
        pro: { name: 'Pro', price: 99, questions: 100 },
        enterprise: { name: 'Enterprise', price: 299, questions: 1000 }
      };
      
      const pkg = packageData[packageType];
      if (!pkg) return;
      
      const newPrice = prompt(`السعر الحالي لباقة ${pkg.name}: ${pkg.price} ريال\nأدخل السعر الجديد:`, pkg.price);
      if (newPrice === null) return;
      
      const newQuestions = prompt(`عدد الأسئلة الحالي: ${pkg.questions}\nأدخل عدد الأسئلة الجديد:`, pkg.questions);
      if (newQuestions === null) return;
      
      showNotification('تعديل الباقات يتطلب ربطاً بالخادم. لم يتم الحفظ.', 'warning');
    }

    // Company Tests Functions
    let testQuestions = [
      { id: 1, text: 'هل تتعامل الشركة مع البنوك الربوية؟', category: 'financial', weight: 10, yesResult: 'non_compliant', noResult: 'compliant' },
      { id: 2, text: 'هل توجد هيئة رقابة شرعية في الشركة؟', category: 'governance', weight: 8, yesResult: 'compliant', noResult: 'needs_review' },
      { id: 3, text: 'هل تتضمن العقود شروط غرر أو جهالة؟', category: 'contracts', weight: 9, yesResult: 'non_compliant', noResult: 'compliant' },
      { id: 4, text: 'هل تستثمر الشركة في قطاعات محرمة؟', category: 'investments', weight: 10, yesResult: 'non_compliant', noResult: 'compliant' },
      { id: 5, text: 'هل تلتزم الشركة بإخراج الزكاة؟', category: 'financial', weight: 7, yesResult: 'compliant', noResult: 'needs_review' },
    ];

    function getCategoryLabel(category) {
      const labels = {
        'financial': 'المعاملات المالية',
        'contracts': 'العقود والاتفاقيات',
        'investments': 'الاستثمارات',
        'operations': 'العمليات التشغيلية',
        'governance': 'الحوكمة الشرعية'
      };
      return labels[category] || category;
    }

    function getResultLabel(result) {
      const labels = {
        'compliant': 'متوافق',
        'non_compliant': 'غير متوافق',
        'needs_review': 'يحتاج مراجعة'
      };
      return labels[result] || result;
    }

    function getResultColor(result) {
      const colors = {
        'compliant': 'bg-green-100 text-green-700',
        'non_compliant': 'bg-red-100 text-red-700',
        'needs_review': 'bg-yellow-100 text-yellow-700'
      };
      return colors[result] || 'bg-gray-100 text-gray-700';
    }

    function renderTestQuestions(filter = 'all') {
      const container = document.getElementById('testQuestionsList');
      if (!container) return;

      const filtered = filter === 'all' ? testQuestions : testQuestions.filter(q => q.category === filter);
      
      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">لا توجد أسئلة في هذه الفئة</p>';
        return;
      }

      container.innerHTML = filtered.map(q => `
        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition" data-id="${q.id}">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <p class="font-medium text-gray-800 mb-2">${q.text}</p>
              <div class="flex flex-wrap gap-2">
                <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">${getCategoryLabel(q.category)}</span>
                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">الوزن: ${q.weight}</span>
                <span class="px-3 py-1 ${getResultColor(q.yesResult)} rounded-full text-xs">نعم = ${getResultLabel(q.yesResult)}</span>
                <span class="px-3 py-1 ${getResultColor(q.noResult)} rounded-full text-xs">لا = ${getResultLabel(q.noResult)}</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="editTestQuestion(${q.id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
              </button>
              <button onclick="deleteTestQuestion(${q.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function filterTestQuestions() {
      const filter = document.getElementById('filterCategory').value;
      renderTestQuestions(filter);
    }

    function editTestQuestion(id) {
      const question = testQuestions.find(q => q.id === id);
      if (!question) return;

      document.getElementById('newQuestionText').value = question.text;
      document.getElementById('newQuestionCategory').value = question.category;
      document.getElementById('newQuestionWeight').value = question.weight;
      document.getElementById('newQuestionYesResult').value = question.yesResult;
      document.getElementById('newQuestionNoResult').value = question.noResult;

      // Remove the old question
      testQuestions = testQuestions.filter(q => q.id !== id);
      renderTestQuestions(document.getElementById('filterCategory').value);
      
      showNotification('تم تحميل السؤال للتعديل', 'info');
    }

    function deleteTestQuestion(id) {
      if (!confirm('هل أنت متأكد من حذف هذا السؤال؟')) return;
      
      testQuestions = testQuestions.filter(q => q.id !== id);
      renderTestQuestions(document.getElementById('filterCategory').value);
      showNotification('تم حذف السؤال بنجاح', 'success');
    }

    document.getElementById('addTestQuestionForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const newQuestion = {
        id: Date.now(),
        text: document.getElementById('newQuestionText').value,
        category: document.getElementById('newQuestionCategory').value,
        weight: parseInt(document.getElementById('newQuestionWeight').value),
        yesResult: document.getElementById('newQuestionYesResult').value,
        noResult: document.getElementById('newQuestionNoResult').value
      };

      testQuestions.push(newQuestion);
      renderTestQuestions(document.getElementById('filterCategory')?.value || 'all');
      
      // Reset form
      e.target.reset();
      document.getElementById('newQuestionWeight').value = '5';
      
      showNotification('تم إضافة السؤال بنجاح', 'success');
    });

    // Growth Engine Settings Functions (Backend-persisted)
    async function savePricingSettings() {
      try {
        await trpc("POST", "system.updateSystemSettings", {
          proPrice: parseFloat(document.getElementById('proPrice').value),
          platformCommission: parseFloat(document.getElementById('platformCommission').value),
          minExpertPrice: parseFloat(document.getElementById('minExpertPrice').value),
        });
        showNotification('تم حفظ إعدادات التسعير بنجاح', 'success');
      } catch (error) {
        console.error('Error saving pricing settings:', error);
        showNotification('حدث خطأ في حفظ الإعدادات', 'error');
      }
    }

    async function saveComplexitySettings() {
      try {
        await trpc("POST", "system.updateSystemSettings", {
          financialThreshold: parseFloat(document.getElementById('financialThreshold').value),
          aiConfidenceThreshold: parseFloat(document.getElementById('aiConfidenceThreshold').value),
          sensitiveKeywords: document.getElementById('sensitiveKeywords').value,
        });
        showNotification('تم حفظ محفزات التعقيد بنجاح', 'success');
      } catch (error) {
        console.error('Error saving complexity settings:', error);
        showNotification('حدث خطأ في حفظ الإعدادات', 'error');
      }
    }

    async function saveBlurSettings() {
      try {
        await trpc("POST", "system.updateSystemSettings", {
          blurEnabled: document.getElementById('blurEnabled').checked,
          showIssueCount: document.getElementById('showIssueCount').checked,
        });
        showNotification('تم حفظ إعدادات الضبابية بنجاح', 'success');
      } catch (error) {
        console.error('Error saving blur settings:', error);
        showNotification('حدث خطأ في حفظ الإعدادات', 'error');
      }
    }

    async function loadGrowthSettings() {
      try {
        const settings = await trpc("GET", "system.getSystemSettings");
        if (settings) {
          // Load pricing settings
          if (settings.proPrice) document.getElementById('proPrice').value = settings.proPrice;
          if (settings.platformCommission) document.getElementById('platformCommission').value = settings.platformCommission;
          if (settings.minExpertPrice) document.getElementById('minExpertPrice').value = settings.minExpertPrice;

          // Load complexity settings
          if (settings.financialThreshold) document.getElementById('financialThreshold').value = settings.financialThreshold;
          if (settings.aiConfidenceThreshold) document.getElementById('aiConfidenceThreshold').value = settings.aiConfidenceThreshold;
          if (settings.sensitiveKeywords) document.getElementById('sensitiveKeywords').value = settings.sensitiveKeywords;

          // Load blur settings
          if (settings.blurEnabled !== undefined) document.getElementById('blurEnabled').checked = settings.blurEnabled;
          if (settings.showIssueCount !== undefined) document.getElementById('showIssueCount').checked = settings.showIssueCount;
        }
      } catch (error) {
        console.error('Error loading system settings:', error);
      }
    }

    // Vendors Management - Using Database API
    let vendors = [];
    
    // Load vendors from database on init
    async function loadVendors() {
      try {
        vendors = await trpc("GET", "vendors.list") || [];
        renderVendors();
        renderPendingApplications();
      } catch (error) {
        console.error('Error loading vendors:', error);
        showNotification('حدث خطأ في تحميل الشركاء', 'error');
      }
    }

    function showAddVendorModal() {
      const modal = document.createElement('div');
      modal.id = 'vendorModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg">
          <h3 class="text-lg font-bold text-gray-800 mb-4">إضافة شريك جديد</h3>
          <form id="addVendorForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">اسم الشركة/المكتب</label>
              <input type="text" id="vendorName" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">التخصص</label>
              <select id="vendorSpecialty" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="شرعي">شرعي</option>
                <option value="قانوني">قانوني</option>
                <option value="مالي">مالي</option>
                <option value="شامل">شامل</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
              <input type="email" id="vendorEmail" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
              <input type="tel" id="vendorPhone" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div class="flex gap-3">
              <button type="submit" class="flex-1 gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">إضافة</button>
              <button type="button" onclick="closeVendorModal()" class="flex-1 bg-gray-100 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-200 transition">إلغاء</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('addVendorForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newVendor = {
          name: document.getElementById('vendorName').value,
          email: document.getElementById('vendorEmail').value,
          phone: document.getElementById('vendorPhone').value,
          specialty: [document.getElementById('vendorSpecialty').value],
          companyName: document.getElementById('vendorCR')?.value || '',
          commissionRate: 30
        };
        
        try {
          await trpc("POST", "vendors.create", newVendor);
          await loadVendors();
          closeVendorModal();
          showNotification('تم إضافة الشريك بنجاح', 'success');
        } catch (error) {
          console.error('Error adding vendor:', error);
          showNotification('حدث خطأ في إضافة الشريك: ' + error.message, 'error');
        }
      });
    }

    function closeVendorModal() {
      document.getElementById('vendorModal')?.remove();
    }

    function renderVendors() {
      const tbody = document.getElementById('vendorsTableBody');
      if (!tbody) return;

      // Filter only active and inactive vendors (not pending)
      const activeVendors = vendors.filter(v => v.status !== 'pending');

      if (activeVendors.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">لا يوجد شركاء بعد</td></tr>';
        // Update stats
        document.getElementById('stat-vendors').textContent = '0';
        document.getElementById('stat-active-vendors').textContent = '0';
        document.getElementById('stat-orders').textContent = '0';
        return;
      }

      tbody.innerHTML = activeVendors.map(vendor => `
        <tr>
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-[#8B1538] rounded-full flex items-center justify-center text-white font-bold">
                ${vendor.name.charAt(0)}
              </div>
              <div>
                <p class="font-medium text-gray-800">${vendor.name}</p>
                <p class="text-sm text-gray-500">${vendor.email}</p>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 text-gray-600">${vendor.specialty}</td>
          <td class="px-6 py-4">
            <div class="flex items-center gap-1">
              <span class="text-yellow-500">★</span>
              <span class="text-gray-800">${vendor.rating || '-'}</span>
            </div>
          </td>
          <td class="px-6 py-4 text-gray-600">${vendor.orders}</td>
          <td class="px-6 py-4">
            <span class="px-3 py-1 rounded-full text-xs font-medium ${vendor.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
              ${vendor.status === 'active' ? 'نشط' : 'موقوف'}
            </span>
          </td>
          <td class="px-6 py-4">
            <button onclick="viewVendorDetails(${vendor.id})" class="text-[#8B1538] hover:text-[#6d1029] text-sm">تفاصيل</button>
            <button onclick="editVendor(${vendor.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-3">تعديل</button>
            <button onclick="toggleVendorStatus(${vendor.id})" class="text-amber-600 hover:text-amber-800 text-sm mr-3">
              ${vendor.status === 'active' ? 'إيقاف' : 'تفعيل'}
            </button>
            <button onclick="deleteVendor(${vendor.id})" class="text-red-600 hover:text-red-800 text-sm mr-3">حذف</button>
          </td>
        </tr>
      `).join('');

      // Update stats (exclude pending)
      const nonPendingVendors = vendors.filter(v => v.status !== 'pending');
      document.getElementById('stat-vendors').textContent = nonPendingVendors.length;
      document.getElementById('stat-active-vendors').textContent = vendors.filter(v => v.status === 'active').length;
      document.getElementById('stat-orders').textContent = nonPendingVendors.reduce((sum, v) => sum + (v.orders || 0), 0);
    }

    async function toggleVendorStatus(id) {
      const vendor = vendors.find(v => v.id === id);
      if (vendor) {
        const newStatus = vendor.status === 'approved' ? 'banned' : 'approved';
        try {
          await trpc("POST", "vendors.update", { id, status: newStatus });
          await loadVendors();
          showNotification('تم تحديث حالة الشريك', 'success');
        } catch (error) {
          console.error('Error updating vendor:', error);
          showNotification('حدث خطأ في تحديث الشريك', 'error');
        }
      }
    }

    async function deleteVendor(id) {
      if (confirm('هل أنت متأكد من حذف هذا الشريك؟')) {
        try {
          await trpc("POST", "vendors.delete", { id });
          await loadVendors();
          showNotification('تم حذف الشريك', 'success');
        } catch (error) {
          console.error('Error deleting vendor:', error);
          showNotification('حدث خطأ في حذف الشريك', 'error');
        }
      }
    }

    // Pending Applications Management
    function renderPendingApplications() {
      const pendingApps = vendors.filter(v => v.status === 'pending');
      const section = document.getElementById('pendingApplicationsSection');
      const list = document.getElementById('pendingApplicationsList');
      
      if (!section || !list) return;
      
      if (pendingApps.length === 0) {
        section.classList.add('hidden');
        return;
      }
      
      section.classList.remove('hidden');
      list.innerHTML = pendingApps.map(app => `
        <div class="flex items-center justify-between p-4 bg-amber-50 rounded-xl border border-amber-200">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-amber-500 rounded-full flex items-center justify-center text-white font-bold">
              ${app.name.charAt(0)}
            </div>
            <div>
              <p class="font-medium text-gray-800">${app.name}</p>
              <p class="text-sm text-gray-500">${app.email} • ${app.specialty}</p>
              ${app.crNumber ? `<p class="text-xs text-gray-400">سجل تجاري: ${app.crNumber}</p>` : ''}
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="approveApplication(${app.id})" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
              قبول
            </button>
            <button onclick="rejectApplication(${app.id})" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
              رفض
            </button>
          </div>
        </div>
      `).join('');
    }
    
    async function approveApplication(id) {
      const vendor = vendors.find(v => v.id === id);
      if (vendor) {
        try {
          const response = await fetch('/api/trpc/vendors.update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ json: { id, status: 'approved' } })
          });
          const result = await response.json();
          if (result.error) throw new Error(result.error.message);
          
          await loadVendors();
          showNotification('تم قبول طلب ' + vendor.name + ' بنجاح', 'success');
        } catch (error) {
          console.error('Error approving vendor:', error);
          showNotification('حدث خطأ في قبول الطلب', 'error');
        }
      }
    }
    
    async function rejectApplication(id) {
      if (confirm('هل أنت متأكد من رفض هذا الطلب؟')) {
        try {
          await trpc("POST", "vendors.delete", { id });
          await loadVendors();
          showNotification('تم رفض الطلب', 'success');
        } catch (error) {
          console.error('Error rejecting vendor:', error);
          showNotification('حدث خطأ في رفض الطلب', 'error');
        }
      }
    }

    // Initialize
    loadDocuments();
    loadUsers();
    loadConsultants();
    loadVendors();
    loadDailyLimits();
    // View Vendor Details Function
    function viewVendorDetails(id) {
      const vendor = vendors.find(v => v.id === id);
      if (!vendor) return;
      
      const modal = document.createElement('div');
      modal.id = 'vendorDetailsModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">تفاصيل الشريك</h3>
            <button onclick="document.getElementById('vendorDetailsModal').remove()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
          
          <div class="flex items-center gap-4 mb-6">
            <div class="w-20 h-20 bg-[#8B1538] rounded-full flex items-center justify-center text-white text-2xl font-bold">
              ${vendor.name.charAt(0)}
            </div>
            <div>
              <h4 class="text-xl font-bold text-gray-800">${vendor.name}</h4>
              <p class="text-gray-500">${vendor.specialty}</p>
              <span class="px-3 py-1 rounded-full text-xs font-medium ${vendor.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                ${vendor.status === 'active' ? 'نشط' : 'موقوف'}
              </span>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-sm text-gray-500 mb-1">البريد الإلكتروني</p>
              <p class="font-medium text-gray-800">${vendor.email}</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-sm text-gray-500 mb-1">رقم الهاتف</p>
              <p class="font-medium text-gray-800">${vendor.phone || 'غير محدد'}</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-sm text-gray-500 mb-1">التقييم</p>
              <p class="font-medium text-gray-800">★ ${vendor.rating || '-'}</p>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-sm text-gray-500 mb-1">عدد الطلبات</p>
              <p class="font-medium text-gray-800">${vendor.orders || 0}</p>
            </div>
          </div>
          
          <div class="bg-green-50 rounded-xl p-4 mb-6">
            <h5 class="font-bold text-green-800 mb-2">البيانات المالية</h5>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-green-600">إجمالي الأرباح</p>
                <p class="text-xl font-bold text-green-700">${vendor.totalEarnings || 0} د.ك</p>
              </div>
              <div>
                <p class="text-sm text-green-600">الرصيد الحالي</p>
                <p class="text-xl font-bold text-green-700">${vendor.balance || 0} د.ك</p>
              </div>
            </div>
          </div>
          
          ${vendor.bankName ? `
          <div class="bg-blue-50 rounded-xl p-4 mb-6">
            <h5 class="font-bold text-blue-800 mb-2">البيانات البنكية</h5>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-blue-600">البنك</p>
                <p class="font-medium text-blue-800">${vendor.bankName}</p>
              </div>
              <div>
                <p class="text-sm text-blue-600">IBAN</p>
                <p class="font-medium text-blue-800">${vendor.iban || 'غير محدد'}</p>
              </div>
            </div>
          </div>
          ` : ''}
          
          ${vendor.crNumber ? `
          <div class="bg-gray-50 rounded-xl p-4 mb-6">
            <p class="text-sm text-gray-500">رقم السجل التجاري</p>
            <p class="font-medium text-gray-800">${vendor.crNumber}</p>
          </div>
          ` : ''}
          
          <div class="flex gap-3">
            <button onclick="editVendor(${vendor.id}); document.getElementById('vendorDetailsModal').remove();" class="flex-1 gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90">تعديل</button>
            <button onclick="toggleVendorStatus(${vendor.id}); document.getElementById('vendorDetailsModal').remove();" class="flex-1 bg-amber-500 text-white py-3 rounded-xl font-semibold hover:opacity-90">
              ${vendor.status === 'active' ? 'إيقاف' : 'تفعيل'}
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Edit Vendor Function
    function editVendor(id) {
      const vendor = vendors.find(v => v.id === id);
      if (!vendor) return;
      
      const modal = document.createElement('div');
      modal.id = 'editVendorModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">تعديل بيانات الشريك</h3>
            <button onclick="document.getElementById('editVendorModal').remove()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
          
          <form id="editVendorForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">اسم الشركة/المكتب</label>
              <input type="text" id="editVendorName" value="${vendor.name}" class="w-full px-4 py-3 rounded-xl border border-gray-200" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
              <input type="email" id="editVendorEmail" value="${vendor.email}" class="w-full px-4 py-3 rounded-xl border border-gray-200" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
              <input type="tel" id="editVendorPhone" value="${vendor.phone || ''}" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">التخصص</label>
              <select id="editVendorSpecialty" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                <option value="استشارات شرعية" ${vendor.specialty === 'استشارات شرعية' ? 'selected' : ''}>استشارات شرعية</option>
                <option value="تحليل عقود" ${vendor.specialty === 'تحليل عقود' ? 'selected' : ''}>تحليل عقود</option>
                <option value="فحص أسهم" ${vendor.specialty === 'فحص أسهم' ? 'selected' : ''}>فحص أسهم</option>
                <option value="مراجعة شرعية" ${vendor.specialty === 'مراجعة شرعية' ? 'selected' : ''}>مراجعة شرعية</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">رقم السجل التجاري</label>
              <input type="text" id="editVendorCR" value="${vendor.crNumber || ''}" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div class="border-t pt-4">
              <h4 class="font-medium text-gray-800 mb-3">البيانات البنكية</h4>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">اسم البنك</label>
                  <input type="text" id="editVendorBank" value="${vendor.bankName || ''}" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">IBAN</label>
                  <input type="text" id="editVendorIBAN" value="${vendor.iban || ''}" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                </div>
              </div>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="submit" class="flex-1 gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90">حفظ التعديلات</button>
              <button type="button" onclick="document.getElementById('editVendorModal').remove()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold">إلغاء</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      
      document.getElementById('editVendorForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const updatedData = {
          id: vendor.id,
          name: document.getElementById('editVendorName').value,
          email: document.getElementById('editVendorEmail').value,
          phone: document.getElementById('editVendorPhone').value,
          specialty: [document.getElementById('editVendorSpecialty').value],
          companyName: document.getElementById('editVendorCR').value,
          bankName: document.getElementById('editVendorBank').value,
          iban: document.getElementById('editVendorIBAN').value
        };
        
        try {
          await trpc("POST", "vendors.update", updatedData);
          document.getElementById('editVendorModal').remove();
          await loadVendors();
          showNotification('تم تحديث بيانات الشريك بنجاح', 'success');
        } catch (error) {
          console.error('Error updating vendor:', error);
          showNotification('حدث خطأ في تحديث الشريك', 'error');
        }
      });
    }
    
    // Render Withdrawal Requests (Backend-persisted)
    async function renderWithdrawalRequests() {
      const list = document.getElementById('withdrawalRequestsList');
      if (!list) return;
      
      try {
        const withdrawals = await trpc("GET", "system.listWithdrawals", { status: "pending" });
        const pendingWithdrawals = withdrawals.filter(w => w.status === 'pending');
        
        if (pendingWithdrawals.length === 0) {
          list.innerHTML = '<p class="text-gray-500 text-center py-4">لا توجد طلبات سحب حالياً</p>';
          return;
        }
        
        list.innerHTML = pendingWithdrawals.map(w => {
          return `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                  ${w.advisorId || '?'}
                </div>
                <div>
                  <p class="font-medium text-gray-800">طلب سحب #${w.id}</p>
                  <p class="text-sm text-gray-500">المبلغ: ${(w.amountKwd / 1000).toFixed(3)} د.ك</p>
                  <p class="text-xs text-gray-400">${new Date(w.createdAt).toLocaleDateString('ar-SA')}</p>
                  ${w.status === 'approved' ? '<p class="text-xs text-yellow-600">في انتظار التحويل (البوابة غير متصلة)</p>' : ''}
                </div>
              </div>
              <div class="flex gap-2">
                ${w.status === 'pending' ? `
                  <button onclick="approveWithdrawal(${w.id})" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">موافقة</button>
                  <button onclick="rejectWithdrawal(${w.id})" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">رفض</button>
                ` : `
                  <span class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg">${w.status === 'approved' ? 'موافق' : w.status === 'rejected' ? 'مرفوض' : w.status}</span>
                `}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading withdrawals:', error);
        list.innerHTML = '<p class="text-red-500 text-center py-4">حدث خطأ في تحميل طلبات السحب</p>';
      }
    }
    
    async function approveWithdrawal(id) {
      try {
        await trpc("POST", "system.approveWithdrawal", { withdrawalId: id });
        await renderWithdrawalRequests();
        showNotification('تمت الموافقة على طلب السحب. في انتظار التحويل (البوابة غير متصلة)', 'success');
      } catch (error) {
        console.error('Error approving withdrawal:', error);
        showNotification('حدث خطأ في الموافقة على طلب السحب', 'error');
      }
    }
    
    async function rejectWithdrawal(id) {
      const reason = prompt('سبب الرفض (اختياري):');
      try {
        await trpc("POST", "system.rejectWithdrawal", { withdrawalId: id, reason: reason || null });
        await renderWithdrawalRequests();
        showNotification('تم رفض طلب السحب', 'warning');
      } catch (error) {
        console.error('Error rejecting withdrawal:', error);
        showNotification('حدث خطأ في رفض طلب السحب', 'error');
      }
    }
    
    // Update Platform Revenue Stats
    function updateRevenueStats() {
      const totalRevenue = vendors.reduce((sum, v) => sum + ((v.totalEarnings || 0) / 0.7), 0);
      const partnersShare = vendors.reduce((sum, v) => sum + (v.totalEarnings || 0), 0);
      const platformShare = totalRevenue - partnersShare;
      
      const totalRevenueEl = document.getElementById('totalRevenue');
      const partnersShareEl = document.getElementById('partnersShare');
      const platformShareEl = document.getElementById('platformShare');
      const statRevenueEl = document.getElementById('stat-revenue');
      
      if (totalRevenueEl) totalRevenueEl.textContent = totalRevenue.toFixed(2) + ' د.ك';
      if (partnersShareEl) partnersShareEl.textContent = partnersShare.toFixed(2) + ' د.ك';
      if (platformShareEl) platformShareEl.textContent = platformShare.toFixed(2) + ' د.ك';
      if (statRevenueEl) statRevenueEl.textContent = platformShare.toFixed(2) + ' د.ك';
    }

    renderTestQuestions();
    loadGrowthSettings();
    renderVendors();
    renderCustomPackages();
    renderPendingApplications();
    renderWithdrawalRequests();
    updateRevenueStats();
    
    // Notification Target Change Handler
    document.getElementById('notificationTarget').addEventListener('change', function() {
      const specificSelect = document.getElementById('specificVendorSelect');
      const vendorSelect = document.getElementById('selectedVendorId');
      
      if (this.value === 'specific') {
        specificSelect.classList.remove('hidden');
        // Populate vendor dropdown
        vendorSelect.innerHTML = vendors
          .filter(v => v.status === 'active')
          .map(v => `<option value="${v.id}">${v.name}</option>`)
          .join('');
      } else {
        specificSelect.classList.add('hidden');
      }
    });
    
    // Vendor Notification Form Submit
    document.getElementById('vendorNotificationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const target = document.getElementById('notificationTarget').value;
      const title = document.getElementById('notificationTitle').value;
      const message = document.getElementById('notificationMessage').value;
      
      let targetVendors = [];
      
      if (target === 'all') {
        targetVendors = vendors;
      } else if (target === 'active') {
        targetVendors = vendors.filter(v => v.status === 'active');
      } else if (target === 'specific') {
        const vendorId = parseInt(document.getElementById('selectedVendorId').value);
        targetVendors = vendors.filter(v => v.id === vendorId);
      }
      
      if (targetVendors.length === 0) {
        showNotification('لا يوجد شركاء لإرسال الإشعار إليهم', 'warning');
        return;
      }
      
      // Send via API only (no localStorage fallback)
      try {
        if (target === 'specific') {
          await trpc("POST", "notifications.sendToVendor", { 
            vendorId: targetVendors[0].id, 
            title, 
            message, 
            type: 'admin' 
          });
        } else {
          await trpc("POST", "notifications.sendToAllVendors", { 
            title, 
            message, 
            type: 'admin' 
          });
        }
      } catch (err) {
        console.log('API notification failed, using localStorage fallback');
      }
      
      showNotification(`تم إرسال الإشعار إلى ${targetVendors.length} شريك`, 'success');
      
      // Reset form
      document.getElementById('notificationTitle').value = '';
      document.getElementById('notificationMessage').value = '';
    });
  </script>
</body>
</html>
