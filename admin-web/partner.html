<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>خبير - بوابة الشريك</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/superjson@2.2.1/dist/index.umd.js"></script>
  <!-- Always load tRPC helper from backend to avoid 404/MIME issues on live-server -->
  <script src="http://localhost:3000/admin/trpc-client.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f4f1;
      --surface: #ffffff;
      --surface-muted: #fbf8f5;
      --border: #e6dcd2;
      --muted: #6b6460;
      --foreground: #1f1917;
      --primary: #8B1538;
      --primary-2: #C9375D;
      --accent: #D4AF37;
    }
    * { font-family: 'Tajawal', sans-serif; }
    body.bg-gray-50 { background: radial-gradient(circle at 20% 20%, #fbf5f1, #f2ebe7 45%, #eee5e0); color: var(--foreground); }
    h1, h2, h3, h4 { color: var(--foreground); }
    p, span, label { color: var(--muted); }

    /* Surfaces */
    .gradient-bg { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); }
    .gradient-bg-dark { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%); }
    .glass-card { background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border: 1px solid rgba(230, 220, 210, 0.7); box-shadow: 0 20px 40px rgba(0,0,0,0.06); }
    .shadow-lg, .shadow-xl { box-shadow: 0 18px 45px rgba(0,0,0,0.08) !important; border: 1px solid var(--border); }
    .bg-white { background-color: var(--surface) !important; }

    /* Sidebar */
    .sidebar-item { border: 1px solid transparent; border-radius: 14px; }
    .sidebar-item:hover { background: rgba(139, 21, 56, 0.04); }
    .sidebar-item.active { background: rgba(139, 21, 56, 0.08); color: var(--primary); border-right: 3px solid var(--primary); }

    /* Buttons */
    .btn-soft { background: var(--surface-muted); border: 1px solid var(--border); color: var(--foreground); }
    .btn-soft:hover { border-color: var(--primary); color: var(--primary); }

    /* Inputs */
    input, select, textarea { background: var(--surface); border-color: var(--border) !important; color: var(--foreground); }
    input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(139, 21, 56, 0.12); }

    /* Cards / tables */
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border); background: var(--surface); }
    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 14px 30px rgba(0,0,0,0.08); }
    table thead th { background: var(--surface-muted); color: var(--foreground); }
    table tbody tr:nth-child(odd) { background: #fcf9f6; }
    table tbody tr:hover { background: rgba(139, 21, 56, 0.04); }

    /* Status chips */
    .status-pending { background: #FEF3C7; color: #D97706; }
    .status-active { background: #D1FAE5; color: #059669; }
    .status-completed { background: #DBEAFE; color: #2563EB; }
    .status-cancelled { background: #FEE2E2; color: #DC2626; }

    /* Tabs / chips */
    .tab-btn { border: 1px solid var(--border); background: var(--surface); color: var(--muted); }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Dropzones */
    .file-drop-zone { border: 2px dashed var(--border); transition: all 0.3s; background: var(--surface-muted); }
    .file-drop-zone:hover, .file-drop-zone.dragover { border-color: var(--primary); background: rgba(139, 21, 56, 0.05); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center gradient-bg">
    <div class="glass-card rounded-3xl p-10 w-full max-w-md shadow-2xl">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-[#D4AF37] to-[#B8860B] rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
          <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">خبير</h1>
        <p class="text-gray-500 mt-2">بوابة الشريك</p>
      </div>
      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
          <input type="email" id="partnerEmail" required
            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#D4AF37] focus:border-transparent transition"
            placeholder="partner@company.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
          <input type="password" id="partnerPassword" required
            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#D4AF37] focus:border-transparent transition"
            placeholder="••••••••">
        </div>
        <button type="submit"
          class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90 transition shadow-lg">
          تسجيل الدخول
        </button>
      </form>
      <p id="loginError" class="text-red-500 text-center mt-4 hidden">بيانات الدخول غير صحيحة</p>
      <div class="mt-6 text-center">
        <p class="text-gray-500 text-sm">ليس لديك حساب؟</p>
        <button onclick="showRegisterForm()" class="text-[#D4AF37] font-semibold hover:underline">تقدم للانضمام كشريك</button>
      </div>
    </div>
  </div>

  <!-- Register Screen -->
  <div id="registerScreen" class="hidden min-h-screen flex items-center justify-center gradient-bg py-8">
    <div class="glass-card rounded-3xl p-8 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">طلب الانضمام كشريك</h1>
        <p class="text-gray-500 mt-2">أكمل البيانات التالية للتقديم</p>
      </div>
      <form id="registerForm" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">اسم الشركة/المكتب</label>
            <input type="text" id="regCompanyName" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">رقم السجل التجاري</label>
            <input type="text" id="regCRNumber" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">التخصص</label>
            <select id="regSpecialty" class="w-full px-4 py-3 rounded-xl border border-gray-200">
              <option value="شرعي">استشارات شرعية</option>
              <option value="قانوني">استشارات قانونية</option>
              <option value="مالي">استشارات مالية</option>
              <option value="شامل">شامل</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
            <input type="email" id="regEmail" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
            <input type="tel" id="regPhone" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
            <input type="password" id="regPassword" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
          </div>
        </div>
        
        <div class="border-t pt-4 mt-4">
          <h3 class="font-semibold text-gray-800 mb-3">البيانات البنكية</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">اسم البنك</label>
              <input type="text" id="regBankName" required class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">رقم IBAN</label>
              <input type="text" id="regIBAN" required class="w-full px-4 py-3 rounded-xl border border-gray-200" placeholder="KW...">
            </div>
          </div>
        </div>

        <div class="border-t pt-4 mt-4">
          <h3 class="font-semibold text-gray-800 mb-3">المستندات المطلوبة</h3>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">صورة الترخيص</label>
              <input type="file" id="regLicense" accept=".pdf,.jpg,.png" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">السجل التجاري</label>
              <input type="file" id="regCRDoc" accept=".pdf,.jpg,.png" class="w-full px-4 py-3 rounded-xl border border-gray-200">
            </div>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button type="submit" class="flex-1 gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90 transition">
            إرسال الطلب
          </button>
          <button type="button" onclick="showLoginForm()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition">
            رجوع
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Sidebar -->
    <aside class="fixed right-0 top-0 h-full w-72 bg-white shadow-xl z-50 flex flex-col">
      <div class="p-6 border-b">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>
          <div>
            <h1 class="font-bold text-xl text-gray-800">خبير</h1>
            <p class="text-xs text-gray-500">بوابة الشريك</p>
          </div>
        </div>
      </div>
      
      <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
        <button onclick="showSection('dashboard-section', event)" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
          <span>لوحة المعلومات</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">الطلبات</p>
        </div>
        <button onclick="showSection('orders-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
          <span>الطلبات الجديدة</span>
          <span id="newOrdersBadge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
        </button>
        <button onclick="showSection('active-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>الطلبات النشطة</span>
        </button>
        <button onclick="showSection('completed-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>الطلبات المكتملة</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">المالية</p>
        </div>
        <button onclick="showSection('earnings-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>الأرباح</span>
        </button>
        <button onclick="showSection('withdraw-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
          <span>طلب سحب</span>
        </button>
        <button onclick="showSection('transactions-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
          <span>سجل المعاملات</span>
        </button>
        
        <div class="pt-2 pb-1">
          <p class="px-4 text-xs font-semibold text-gray-400 uppercase">الإعدادات</p>
        </div>
        <button onclick="showSection('notifications-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
          <span>الإشعارات</span>
          <span id="notificationsBadge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
        </button>
        <button onclick="showSection('profile-section', event)" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
          <span>الملف الشخصي</span>
        </button>
      </nav>

      <div class="p-4 border-t">
        <div class="bg-gradient-to-r from-[#D4AF37] to-[#B8860B] rounded-xl p-4 text-white mb-4">
          <p class="text-sm opacity-80">الرصيد المتاح</p>
          <p class="text-2xl font-bold" id="availableBalance">0.000 د.ك</p>
        </div>
        <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-500 hover:bg-red-50 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          <span>تسجيل الخروج</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="mr-72 p-8">
      <!-- Dashboard Section -->
      <section id="dashboard-section">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">مرحباً، <span id="partnerName">الشريك</span></h2>
          <p class="text-gray-500 mt-1">نظرة عامة على أدائك في منصة خبير</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              </div>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-total-earnings">0.000 د.ك</p>
            <p class="text-gray-500 text-sm mt-1">إجمالي الأرباح</p>
          </div>

          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
              </div>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-total-orders">0</p>
            <p class="text-gray-500 text-sm mt-1">إجمالي الطلبات</p>
          </div>

          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              </div>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-pending-orders">0</p>
            <p class="text-gray-500 text-sm mt-1">طلبات قيد الانتظار</p>
          </div>

          <div class="stat-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
              </div>
            </div>
            <p class="text-3xl font-bold text-gray-800" id="stat-rating">-</p>
            <p class="text-gray-500 text-sm mt-1">التقييم</p>
          </div>
        </div>

        <!-- Financial Summary -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">ملخص الأرباح</h3>
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-gray-500">إجمالي الإيرادات</span>
                <span class="font-bold text-gray-800" id="summary-revenue">0.000 د.ك</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-500">رسوم المنصة (30%)</span>
                <span class="font-bold text-red-500" id="summary-fees">-0.000 د.ك</span>
              </div>
              <div class="border-t pt-4 flex justify-between items-center">
                <span class="text-gray-800 font-semibold">صافي الأرباح (70%)</span>
                <span class="font-bold text-green-600 text-lg" id="summary-net">0.000 د.ك</span>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">حالة الرصيد</h3>
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-gray-500">الرصيد المتاح</span>
                <span class="font-bold text-green-600" id="balance-available">0.000 د.ك</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-500">الرصيد المعلق</span>
                <span class="font-bold text-amber-600" id="balance-pending">0.000 د.ك</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-500">قيد السحب</span>
                <span class="font-bold text-blue-600" id="balance-withdrawing">0.000 د.ك</span>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">إحصائيات الأداء</h3>
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-gray-500">معدل القبول</span>
                <span class="font-bold text-gray-800" id="perf-acceptance">0%</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-500">متوسط وقت الإنجاز</span>
                <span class="font-bold text-gray-800" id="perf-time">- يوم</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-500">معدل رضا العملاء</span>
                <span class="font-bold text-gray-800" id="perf-satisfaction">0%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Orders -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <div class="flex items-center justify-between mb-6">
            <h3 class="font-semibold text-gray-800">آخر الطلبات</h3>
            <button onclick="showSection('orders-section')" class="text-[#D4AF37] hover:underline text-sm">عرض الكل</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">رقم الطلب</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">الخدمة</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">المبلغ</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">الحالة</th>
                  <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">التاريخ</th>
                </tr>
              </thead>
              <tbody id="recentOrdersBody" class="divide-y divide-gray-100">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-gray-500">لا توجد طلبات بعد</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Orders Section -->
      <section id="orders-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">الطلبات الجديدة</h2>
          <p class="text-gray-500 mt-1">طلبات بانتظار موافقتك</p>
        </div>

        <div id="newOrdersList" class="space-y-4">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center text-gray-500">
            لا توجد طلبات جديدة
          </div>
        </div>
      </section>

      <!-- Active Orders Section -->
      <section id="active-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">الطلبات النشطة</h2>
          <p class="text-gray-500 mt-1">الطلبات التي تعمل عليها حالياً</p>
        </div>

        <div id="activeOrdersList" class="space-y-4">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center text-gray-500">
            لا توجد طلبات نشطة
          </div>
        </div>
      </section>

      <!-- Completed Orders Section -->
      <section id="completed-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">الطلبات المكتملة</h2>
          <p class="text-gray-500 mt-1">سجل الطلبات المنجزة</p>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">رقم الطلب</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">الخدمة</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">العميل</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">المبلغ</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">التقييم</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">تاريخ الإنجاز</th>
              </tr>
            </thead>
            <tbody id="completedOrdersBody" class="divide-y divide-gray-100">
              <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">لا توجد طلبات مكتملة</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Earnings Section -->
      <section id="earnings-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">الأرباح</h2>
          <p class="text-gray-500 mt-1">تفاصيل أرباحك ونسب العمولة</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="bg-gradient-to-br from-[#D4AF37] to-[#B8860B] rounded-2xl p-8 text-white">
            <h3 class="text-lg opacity-80 mb-2">صافي الأرباح المتاحة</h3>
            <p class="text-4xl font-bold mb-4" id="earnings-available">0.000 د.ك</p>
            <button onclick="showSection('withdraw-section')" class="bg-white text-[#D4AF37] px-6 py-2 rounded-xl font-semibold hover:bg-gray-100 transition">
              طلب سحب
            </button>
          </div>

          <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">نسبة العمولة</h3>
            <div class="flex items-center gap-4 mb-4">
              <div class="flex-1">
                <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-[#D4AF37] rounded-full" style="width: 70%"></div>
                </div>
              </div>
              <span class="text-2xl font-bold text-[#D4AF37]">70%</span>
            </div>
            <p class="text-gray-500 text-sm">نسبتك من كل طلب مكتمل</p>
            <div class="mt-4 p-4 bg-gray-50 rounded-xl">
              <p class="text-sm text-gray-600">
                <strong>مثال:</strong> عند إتمام طلب بقيمة 100 د.ك، تحصل على 70 د.ك
              </p>
            </div>
          </div>
        </div>

        <!-- Earnings Chart -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
          <h3 class="font-semibold text-gray-800 mb-4">الأرباح الشهرية</h3>
          <div style="height: 300px;">
            <canvas id="earningsChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Withdraw Section -->
      <section id="withdraw-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">طلب سحب</h2>
          <p class="text-gray-500 mt-1">اسحب أرباحك إلى حسابك البنكي</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">طلب سحب جديد</h3>
            <form id="withdrawForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ المطلوب (د.ك)</label>
                <input type="number" id="withdrawAmount" step="0.001" min="10" required 
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-[#D4AF37]">
                <p class="text-sm text-gray-500 mt-1">الحد الأدنى للسحب: 10 د.ك</p>
              </div>
              <div class="bg-gray-50 rounded-xl p-4">
                <p class="text-sm text-gray-600 mb-2">سيتم التحويل إلى:</p>
                <p class="font-semibold text-gray-800" id="withdrawBankInfo">لم يتم تحديد الحساب البنكي</p>
              </div>
              <button type="submit" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90 transition">
                إرسال طلب السحب
              </button>
            </form>
          </div>

          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">طلبات السحب السابقة</h3>
            <div id="withdrawHistory" class="space-y-3">
              <p class="text-gray-500 text-center py-4">لا توجد طلبات سحب سابقة</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Transactions Section -->
      <section id="transactions-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">سجل المعاملات</h2>
          <p class="text-gray-500 mt-1">جميع المعاملات المالية</p>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">التاريخ</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">النوع</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">الوصف</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">المبلغ</th>
                <th class="px-6 py-4 text-right text-sm font-semibold text-gray-600">الحالة</th>
              </tr>
            </thead>
            <tbody id="transactionsBody" class="divide-y divide-gray-100">
              <tr>
                <td colspan="5" class="px-6 py-8 text-center text-gray-500">لا توجد معاملات</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Notifications Section -->
      <section id="notifications-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">الإشعارات</h2>
          <p class="text-gray-500 mt-1">إشعارات ورسائل من إدارة المنصة</p>
        </div>
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <span class="font-semibold text-gray-800">جميع الإشعارات</span>
            <button onclick="markAllNotificationsRead()" class="text-sm text-[#D4AF37] hover:underline">تحديد الكل كمقروء</button>
          </div>
          <div id="notificationsList" class="divide-y divide-gray-100">
            <div class="p-8 text-center text-gray-500">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
              <p>لا توجد إشعارات حالياً</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Profile Section -->
      <section id="profile-section" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-gray-800">الملف الشخصي</h2>
          <p class="text-gray-500 mt-1">إدارة بيانات حسابك</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">معلومات الشركة</h3>
            <form id="profileForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">اسم الشركة/المكتب</label>
                <input type="text" id="profileCompanyName" class="w-full px-4 py-3 rounded-xl border border-gray-200">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
                <input type="email" id="profileEmail" class="w-full px-4 py-3 rounded-xl border border-gray-200" readonly>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
                <input type="tel" id="profilePhone" class="w-full px-4 py-3 rounded-xl border border-gray-200">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">التخصص</label>
                <input type="text" id="profileSpecialty" class="w-full px-4 py-3 rounded-xl border border-gray-200" readonly>
              </div>
              <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
                حفظ التغييرات
              </button>
            </form>
          </div>

          <div class="space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
              <h3 class="font-semibold text-gray-800 mb-4">البيانات البنكية</h3>
              <form id="bankForm" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">اسم البنك</label>
                  <input type="text" id="bankName" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">رقم IBAN</label>
                  <input type="text" id="bankIBAN" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">اسم صاحب الحساب</label>
                  <input type="text" id="bankAccountName" class="w-full px-4 py-3 rounded-xl border border-gray-200">
                </div>
                <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition">
                  تحديث البيانات البنكية
                </button>
              </form>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
              <h3 class="font-semibold text-gray-800 mb-4">المستندات</h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                  <span class="text-gray-600">الترخيص</span>
                  <span class="text-green-600 text-sm">✓ موثق</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                  <span class="text-gray-600">السجل التجاري</span>
                  <span class="text-green-600 text-sm">✓ موثق</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Always point to backend API (fixes live-server 404/MIME issues)
    const API_BASE = "http://localhost:3000";
    const API_URL = API_BASE;
    const TOKEN_KEY = "partner_token";
    let token = null;
    let currentUser = null;
    
    // Load token from localStorage on page load
    function loadStoredToken() {
      const stored = localStorage.getItem(TOKEN_KEY);
      if (stored) {
        token = stored;
        return true;
      }
      return false;
    }
    
    // Save token to localStorage
    function saveToken(newToken) {
      token = newToken;
      localStorage.setItem(TOKEN_KEY, newToken);
    }
    
    // Clear token (logout)
    function clearToken() {
      token = null;
      localStorage.removeItem(TOKEN_KEY);
      showLoginScreen();
    }
    
    // Show/hide screens
    function showLoginScreen() {
      document.getElementById("loginScreen").classList.remove("hidden");
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("registerScreen").classList.add("hidden");
    }
    
    function showDashboardScreen() {
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("registerScreen").classList.add("hidden");
    }
    
    function showRegisterScreen() {
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("dashboardScreen").classList.add("hidden");
      document.getElementById("registerScreen").classList.remove("hidden");
    }
    
    // Initialize tRPC client
    const trpcClient = new TRPCClient(API_URL, () => token);
    
    // Helper function for tRPC calls
    async function trpc(method, path, input) {
      const safeInput = input === undefined ? {} : input;
      return trpcClient.request(path, safeInput, method);
    }

    // Resolve authenticated user context before loading any dashboard data
    async function resolveAuthContext() {
      try {
        const user = await trpc("GET", "auth.me", {});
        if (!user) {
          clearToken();
          throw new Error("يرجى تسجيل الدخول");
        }
        if (!["advisor", "consultant"].includes(user.role)) {
          clearToken();
          throw new Error("هذا الحساب ليس حساب شريك");
        }
        currentUser = user;
        return user;
      } catch (e) {
        clearToken();
        throw e;
      }
    }
    
    // ---------- AUTH ----------
    async function handleLogin(email, password) {
      const emailInput = document.getElementById("partnerEmail");
      const passwordInput = document.getElementById("partnerPassword");
      const errorEl = document.getElementById("loginError");
      const loginForm = document.getElementById("loginForm");
      const submitBtn = loginForm?.querySelector('button[type="submit"]') || loginForm?.querySelector('input[type="submit"]');
      
      // Clear previous errors
      errorEl.classList.add("hidden");
      errorEl.textContent = "";
      
      // Validate inputs
      if (!email || !password) {
        errorEl.textContent = "يرجى إدخال البريد الإلكتروني وكلمة المرور";
        errorEl.classList.remove("hidden");
        return;
      }
      
      // Disable form during request
      emailInput.disabled = true;
      passwordInput.disabled = true;
      const originalText = submitBtn ? (submitBtn.textContent || submitBtn.value) : null;
      if (submitBtn) {
        submitBtn.disabled = true;
        if (submitBtn.textContent !== undefined) {
          submitBtn.textContent = "جاري تسجيل الدخول...";
        } else if (submitBtn.value !== undefined) {
          submitBtn.value = "جاري تسجيل الدخول...";
        }
      }
      
      try {
        console.log('[Partner Login] Attempting login for:', email);
        const data = await trpc("POST", "auth.login", { email, password });
        console.log('[Partner Login] Response received:', data);
        
        // Check response format - server returns { success, token, user }
        if (!data) {
          throw new Error("لم يتم استلام أي بيانات من الخادم");
        }
        
        const token = data.token || data.data?.token;
        const user = data.user || data.data?.user;
        
        if (!token) {
          console.error('[Partner Login] Missing token:', data);
          throw new Error("لم يتم استلام رمز الدخول");
        }
        
        // Check if user is advisor/consultant
        if (user && !['advisor', 'consultant'].includes(user.role)) {
          throw new Error("هذا الحساب ليس حساب شريك");
        }
        
        // Success - save token and redirect
        saveToken(token);
        console.log('[Partner Login] Login successful, resolving context and loading dashboard');
        await resolveAuthContext();
        showDashboardScreen();
        await loadDashboard();
        await loadProfile();
      } catch (e) {
        console.error('[Partner Login] Error:', e);
        const errorMessage = e.message || "بيانات الدخول غير صحيحة";
        errorEl.textContent = errorMessage;
        errorEl.classList.remove("hidden");
        
        // Keep form values on error
        emailInput.value = email;
        passwordInput.value = password;
      } finally {
        // Re-enable form
        emailInput.disabled = false;
        passwordInput.disabled = false;
        if (submitBtn && originalText) {
          submitBtn.disabled = false;
          if (submitBtn.textContent !== undefined) {
            submitBtn.textContent = originalText;
          } else if (submitBtn.value !== undefined) {
            submitBtn.value = originalText;
          }
        }
      }
    }
    
    // Show section helper
    function showSection(sectionId, event) {
      if (event) event.preventDefault();
      // Hide all sections
      document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
      // Show target section
      const target = document.getElementById(sectionId);
      if (target) target.classList.remove("hidden");
      // Update sidebar active state
      document.querySelectorAll(".sidebar-item").forEach(item => item.classList.remove("active"));
      if (event && event.currentTarget) {
        event.currentTarget.classList.add("active");
      }
    }
    
    // ---------- LOAD DATA ----------
    let dashboardData = null;
    async function loadDashboard() {
      try {
        if (!currentUser) {
          await resolveAuthContext();
        }
        clearUI();
        showSection("active-section");

        dashboardData = await trpc("GET", "partner.dashboard", {});

        const { stats, newOrders, activeOrders, completedOrders } = dashboardData;

        // Stats
        const setText = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };
        setText("stat-total-orders", (stats.newCount + stats.activeCount + stats.completedCount).toString());
        setText("stat-pending-orders", stats.newCount.toString());

        // New orders
        renderOrdersList("newOrdersList", newOrders, "pending_advisor");

        // Active orders
        renderOrdersList("activeOrdersList", activeOrders, "active");

        // Completed
        renderCompleted(completedOrders);

        await loadEarnings();
        await loadTransactions();
      } catch (e) {
        if (e.message.includes("10001") || e.message.includes("login")) {
          clearToken();
          alert("انتهت صلاحية الجلسة. يرجى تسجيل الدخول مرة أخرى.");
      } else {
          alert("خطأ في تحميل البيانات: " + e.message);
        }
      }
    }
    
    // ---------- ACTIONS ----------
    async function respond(assignmentId, decision) {
      try {
        console.log('[Partner] Responding to assignment:', { assignmentId, decision });
        const result = await trpc("POST", "consultations.advisorRespond", {
          assignmentId,
          decision
        });
        console.log('[Partner] Response received:', result);
        alert(decision === 'accept' ? 'تم قبول الطلب بنجاح' : 'تم رفض الطلب');
        await loadDashboard();
      } catch (e) {
        console.error('[Partner] Error responding:', e);
        const errorMsg = e.message || e.trpc?.message || 'فشل في معالجة الطلب';
        alert('خطأ: ' + errorMsg);
      }
    }
    
    async function sendMessage(requestId, content) {
      if (!content || !content.trim()) {
        alert("يرجى إدخال رسالة");
        return;
      }
      try {
        await trpc("POST", "consultations.addMessage", {
          requestId,
          content: content.trim()
        });
        // Clear input
        const input = document.getElementById(`msg-${requestId}`);
        if (input) input.value = "";
        await loadDashboard();
      } catch (e) {
        alert(e.message);
      }
    }
    
    // ---------- RENDER ----------
    function renderOrdersList(containerId, orders, mode) {
      const container = document.getElementById(containerId);
      if (!container) return;
      if (!orders || orders.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center text-gray-500">لا توجد بيانات</div>';
        return;
      }
      container.innerHTML = "";
      orders.forEach((order) => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-xl p-6 shadow-sm border border-gray-100";
        const status = order.status;
        let html = `
          <h3 class="font-semibold text-gray-800 mb-2">${order.summary || "استشارة"}</h3>
          <p class="text-sm text-gray-600 mb-4">الحالة: <span class="font-medium">${status}</span></p>
        `;
        if (mode === "pending_advisor") {
          html += `
          <div class="flex gap-3">
              <button onclick="respond(${order.assignmentId}, 'accept')" 
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                قبول
            </button>
              <button onclick="respond(${order.assignmentId}, 'decline')" 
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              رفض
            </button>
          </div>
          `;
        }
        if (mode === "active" && (status === "paid" || status === "in_progress")) {
          html += `
            <div class="space-y-3">
              <textarea id="msg-${order.requestId}" 
                placeholder="اكتب رسالتك هنا..." 
                class="w-full px-4 py-2 border border-gray-200 rounded-lg"></textarea>
              <button onclick="sendMessage(${order.requestId}, document.getElementById('msg-${order.requestId}').value)" 
                class="px-4 py-2 bg-[#D4AF37] text-white rounded-lg hover:opacity-90">
                إرسال
              </button>
            </div>
          `;
        }
        if (status === "accepted") {
          html += `<p class="text-gray-600">تم قبول الطلب، بانتظار الدفع للبدء بالمحادثة.</p>`;
        }
        if (status === "awaiting_payment") {
          html += `<p class="text-gray-600">في انتظار دفع المستخدم</p>`;
        }
        card.innerHTML = html;
        container.appendChild(card);
      });
    }

    function renderCompleted(orders) {
      const tbody = document.getElementById("completedOrdersBody");
      if (!tbody) return;
      if (!orders || orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">لا توجد طلبات مكتملة</td></tr>';
        return;
      }
      tbody.innerHTML = "";
      orders.forEach((o) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-6 py-4 text-sm text-gray-700">#${o.requestId}</td>
          <td class="px-6 py-4 text-sm text-gray-700">استشارة</td>
          <td class="px-6 py-4 text-sm text-gray-700">-</td>
          <td class="px-6 py-4 text-sm text-gray-700">-</td>
          <td class="px-6 py-4 text-sm text-gray-700">${o.status}</td>
          <td class="px-6 py-4 text-sm text-gray-700">${o.createdAt || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadEarnings() {
      try {
        // Earnings MUST be real:
        // - Totals: released-only (partner.earnings already filters released consultations)
        // - Available balance: ledger-based (released - pending withdrawals)
        const data = await trpc("GET", "partner.earnings", {});
        const balance = await trpc("GET", "partner.getBalance", {});
        const withdrawals = await trpc("GET", "partner.listWithdrawals", {});
        const toKwd = (v) => (v || 0).toFixed(3) + " د.ك";
        const setText = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };
        const releasedNet = data?.netAmountKwd || 0;
        const available = balance?.availableKwd ?? balance?.balanceKwd ?? 0;

        const withdrawing = Array.isArray(withdrawals)
          ? withdrawals
              .filter((w) => ["pending", "approved", "processing"].includes(w.status))
              .reduce((sum, w) => sum + (w.amountKwd || 0), 0)
          : 0;

        setText("stat-total-earnings", toKwd(releasedNet));
        setText("summary-revenue", toKwd(data.grossAmountKwd || 0));
        setText("summary-fees", "-" + toKwd(data.platformFeeKwd || 0));
        setText("summary-net", toKwd(releasedNet));

        // Balance breakdown (no fake balances)
        setText("balance-available", toKwd(available));
        setText("balance-withdrawing", toKwd(withdrawing));
        setText("balance-pending", toKwd(0));

        const balEl = document.getElementById("availableBalance");
        if (balEl) balEl.textContent = toKwd(available);
        const earnEl = document.getElementById("earnings-available");
        if (earnEl) earnEl.textContent = toKwd(available);
      } catch (e) {
        alert(e.message);
      }
    }

    async function loadTransactions() {
      try {
        const rows = await trpc("GET", "partner.transactions", {});
        const tbody = document.getElementById("transactionsBody");
        if (!tbody) return;
        if (!rows || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">لا توجد معاملات</td></tr>';
          return;
        }
        tbody.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-6 py-4 text-sm text-gray-700">${r.createdAt || ""}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${r.serviceType}</td>
            <td class="px-6 py-4 text-sm text-gray-700">#${r.requestId || "-"}</td>
            <td class="px-6 py-4 text-sm text-gray-700">${(r.amount || 0).toFixed ? r.amount.toFixed(3) : r.amount} د.ك</td>
            <td class="px-6 py-4 text-sm text-gray-700">${r.status}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        alert(e.message);
      }
    }

    function clearUI() {
      const container = document.getElementById("activeOrdersList");
      if (container) {
        container.innerHTML = "";
      }
    }
    
    // Logout handler
    function handleLogout() {
      if (confirm("هل أنت متأكد من تسجيل الخروج؟")) {
        clearToken();
      }
    }

    // Profile load/save
    async function loadProfile() {
      try {
        if (!currentUser) {
          await resolveAuthContext();
        }
        const profile = await trpc("GET", "partner.profileGet", {});
        const setVal = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = val || "";
        };
        setVal("profileCompanyName", profile.companyName);
        setVal("profileEmail", profile.email);
        setVal("profilePhone", profile.phone);
        setVal("profileSpecialty", profile.specialty);
        setVal("bankName", profile.bank?.name);
        setVal("bankIBAN", profile.bank?.iban);
        setVal("bankAccountName", profile.bank?.accountName);
      } catch (e) {
        console.error("Profile load failed", e);
      }
    }

    async function saveProfile(e) {
      e?.preventDefault();
      try {
        await trpc("POST", "partner.profileUpdate", {
          companyName: document.getElementById("profileCompanyName")?.value || null,
          phone: document.getElementById("profilePhone")?.value || null,
          specialty: document.getElementById("profileSpecialty")?.value || null,
          bank: {
            name: document.getElementById("bankName")?.value || null,
            iban: document.getElementById("bankIBAN")?.value || null,
            accountName: document.getElementById("bankAccountName")?.value || null,
          },
        });
        alert("تم حفظ البيانات");
      } catch (e) {
        alert(e.message);
      }
    }
    
    // Wire up login form
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const email = document.getElementById("partnerEmail").value.trim();
      const password = document.getElementById("partnerPassword").value;
      
      await handleLogin(email, password);
    });

    document.getElementById("profileForm")?.addEventListener("submit", saveProfile);
    document.getElementById("bankForm")?.addEventListener("submit", saveProfile);
    
    // ---------- REGISTRATION ----------
    async function handleRegister(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const form = document.getElementById("registerForm");
      const submitBtn = form?.querySelector('button[type="submit"]');
      const errorEl = document.createElement("div");
      errorEl.className = "text-red-500 text-center mt-4 hidden";
      errorEl.id = "registerError";
      
      // Remove existing error if any
      const existingError = document.getElementById("registerError");
      if (existingError) existingError.remove();
      form?.parentElement?.appendChild(errorEl);
      
      // Get form values
      const companyName = document.getElementById("regCompanyName")?.value.trim();
      const email = document.getElementById("regEmail")?.value.trim().toLowerCase();
      const password = document.getElementById("regPassword")?.value;
      const phone = document.getElementById("regPhone")?.value.trim();
      const specialty = document.getElementById("regSpecialty")?.value;
      const bankName = document.getElementById("regBankName")?.value.trim();
      const iban = document.getElementById("regIBAN")?.value.trim();
      
      // Validate
      if (!companyName) {
        errorEl.textContent = "يرجى إدخال اسم الشركة/المكتب";
        errorEl.classList.remove("hidden");
        return;
      }
      if (!email) {
        errorEl.textContent = "يرجى إدخال البريد الإلكتروني";
        errorEl.classList.remove("hidden");
        return;
      }
      if (!password || password.length < 8) {
        errorEl.textContent = "كلمة المرور يجب أن تكون 8 أحرف على الأقل";
        errorEl.classList.remove("hidden");
        return;
      }
      
      // Disable form
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "جاري الإرسال...";
      }
      
      try {
        console.log('[Partner Register] Submitting application...');
        const result = await trpc("POST", "partnerApplications.submit", {
          fullName: companyName, // Use company name as full name
          email,
          password,
          phone: phone || undefined,
          specialization: specialty || undefined,
          // Note: Bank info and documents would be stored separately after approval
        });
        
        console.log('[Partner Register] Application submitted:', result);
        
        alert("تم إرسال الطلب بنجاح!\n\nسيتم مراجعة طلبك من قبل فريقنا وسنتواصل معك قريباً.");
        showLoginScreen();
      } catch (e) {
        console.error('[Partner Register] Error:', e);
        const errorMessage = e.message || "حدث خطأ أثناء إرسال الطلب. يرجى المحاولة مرة أخرى.";
        errorEl.textContent = errorMessage;
        errorEl.classList.remove("hidden");
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "إرسال الطلب";
        }
      }
    }
    
    function showLoginForm() {
      showLoginScreen();
    }
    
    // Wire up registration form
    document.getElementById("registerForm")?.addEventListener("submit", handleRegister);
    
    // Initialize: check for stored token
    (async function init() {
      if (loadStoredToken()) {
        // Try to load dashboard with stored token
        try {
          await resolveAuthContext();
          await loadDashboard();
          await loadProfile();
          showDashboardScreen();
        } catch (e) {
          // Token invalid, clear it and show login
          clearToken();
        }
      } else {
        showLoginScreen();
      }
    })();
    
    // Make functions global for onclick handlers
    window.respond = respond;
    window.sendMessage = sendMessage;
    window.showRegisterForm = showRegisterScreen;
    window.showLoginForm = showLoginForm;
    window.handleLogout = handleLogout;
    window.showSection = showSection;
    window.loadDashboard = loadDashboard;
  </script>
</body>
</html>
